<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="config.title">Settings | Moto Pro Manager</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="cookie-consent.js"></script>
    <script src="background-changer.js"></script>
    <script src="js/i18n.js"></script>
</head>
<body class="paddock-page">
    <!-- NAVBAR -->
    <nav class="nav-mobile">
        <div class="nav-mobile-bar">
            <div class="nav-logo">
                <img src="favicon.png" alt="Logo" class="nav-logo-img-mobile">
                <span class="nav-page-title" data-i18n="config.title">Configuraci√≥n</span>
            </div>
            <button class="hamburger" id="hamburgerBtn" aria-label="Men√∫">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
        </div>
    </nav>

    <!-- OVERLAY -->
    <div class="nav-overlay" id="navOverlay"></div>

    <!-- MEN√ö DESPLEGABLE -->
    <div class="nav-mobile-menu" id="navMobileMenu">
        <a href="/paddock" class="nav-mobile-link">üèÅ <span data-i18n="paddock.title">Paddock</span></a>
        <div class="nav-mobile-dropdown">
            <button class="nav-mobile-dropdown-toggle" id="garajeToggle">
                üèçÔ∏è Garaje
                <span class="dropdown-arrow">‚ñº</span>
            </button>
            <div class="nav-mobile-dropdown-menu" id="garajeDropdown">
                <a href="/piloto" class="nav-mobile-link nav-mobile-sub">üë§ Pilotos</a>
                <a href="/moto" class="nav-mobile-link nav-mobile-sub">üèçÔ∏è Moto</a>
            </div>
        </div>
        <a href="/configuracion" class="nav-mobile-link">‚öôÔ∏è <span data-i18n="config.title">Configuraci√≥n</span></a>
        <a href="/logout" class="nav-mobile-link nav-mobile-logout">üö™ <span data-i18n="paddock.logout">Cerrar Sesi√≥n</span></a>
        <div class="nav-mobile-user">
            <div class="nav-user-avatar" id="userAvatarMobile">U</div>
            <div>
                <div class="nav-user-name" id="userNameMobile">...</div>
                <div class="nav-user-team" id="userTeamMobile">Escuder√≠a</div>
                <div class="nav-user-money" id="userBudgetMobile">0 ‚Ç¨</div>
            </div>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="paddock-main">
        <!-- Mi Cuenta -->
        <section class="config-section">
            <h2 class="config-title">üë§ <span data-i18n="config.myAccount">Mi Cuenta</span></h2>
            <div class="config-form">
                <div class="form-group">
                    <label data-i18n="config.username">Nombre de usuario</label>
                    <input type="text" id="configUsername" placeholder="Usuario">
                </div>
                <div class="form-group">
                    <label data-i18n="config.email">Email</label>
                    <input type="email" id="configEmail" placeholder="usuario@email.com">
                </div>
                <div class="form-group">
                    <label data-i18n="config.teamName">Nombre de la escuder√≠a</label>
                    <input type="text" id="configEscuderia" placeholder="Escuder√≠a Pro">
                </div>
                <div class="form-group">
                    <label data-i18n="config.language">Idioma</label>
                    <select id="languageSelect" class="config-select">
                        <option value="es">üá™üá∏ Espa√±ol</option>
                        <option value="eslat">üåé Espa√±ol Latino</option>
                        <option value="en">üá¨üáß English</option>
                        <option value="pt">üáµüáπ Portugu√™s</option>
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                        <option value="de">üá©üá™ Deutsch</option>
                        <option value="it">üáÆüáπ Italiano</option>
                        <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                        <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                        <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
                    </select>
                </div>

                <!-- Notificaciones -->
                <div class="form-group">
                    <label data-i18n="config.notifications">Notificaciones</label>
                    <div class="toggle-list-inline">
                        <label class="toggle-item">
                            <span data-i18n="config.emailNotifications">Email</span>
                            <input type="checkbox" id="notifyEmail" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-item">
                            <span data-i18n="config.raceNotifications">Carreras</span>
                            <input type="checkbox" id="notifyRaces" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-item">
                            <span data-i18n="config.newsNotifications">Noticias</span>
                            <input type="checkbox" id="notifyNews">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <button class="btn-save" id="btnSaveAccount" data-i18n="config.saveChanges">Guardar Cambios</button>
                <div id="saveMessage" class="form-message"></div>
            </div>
        </section>

        <!-- Cambiar Contrase√±a -->
        <section class="config-section">
            <h2 class="config-title">üîê <span data-i18n="config.changePassword">Cambiar Contrase√±a</span></h2>
            <p class="config-description" data-i18n="config.passwordDesc">Si deseas cambiar tu contrase√±a, te enviaremos un enlace a tu correo electr√≥nico.</p>
            <button class="btn-save btn-secondary" id="btnRequestPassword" data-i18n="config.requestPassword">Solicitar Cambio de Contrase√±a</button>
            <div id="passwordMessage" class="form-message"></div>
        </section>

        <!-- Zona Peligrosa - Eliminar Cuenta -->
        <section class="config-section config-danger">
            <h2 class="config-title config-title-danger">‚ö†Ô∏è <span data-i18n="config.dangerZone">Zona Peligrosa</span></h2>
            <p class="config-danger-text" data-i18n="config.dangerText">Estas acciones son irreversibles. Aseg√∫rate de saber lo que est√°s haciendo.</p>
            <button class="btn-danger" onclick="showDeleteConfirm()">üóëÔ∏è <span data-i18n="config.deleteAccount">Eliminar Mi Cuenta</span></button>
        </section>

        <!-- Panel de Administrador (solo visible para admins) -->
        <section class="config-section config-admin" id="adminSection" style="display: none;">
            <h2 class="config-title config-title-admin">üëë Panel de Administrador</h2>
            <p class="config-description">Herramientas exclusivas para la gesti√≥n del juego.</p>
            
            <div class="admin-tools">
                <div class="admin-tool">
                    <h3>üñºÔ∏è Avatares de Pilotos 3D</h3>
                    <p>Genera avatares 3D realistas con Three.js. Incluyen iluminaci√≥n profesional, sombras y geometr√≠a detallada basada en edad y peso.</p>
                    <div id="avatarStatusInfo" class="admin-status-info"></div>
                    <button class="btn-admin" id="btnGenerateAvatars" onclick="checkAndGenerateAvatars()">
                        üé® Generar Avatares 3D
                    </button>
                    <div id="avatarStatus" class="admin-status"></div>
                </div>
                
                <div class="admin-tool">
                    <h3>üîß Sistema</h3>
                    <p>Herramientas de mantenimiento del sistema.</p>
                    <button class="btn-admin btn-secondary" id="btnEnsureAvatarColumn" onclick="ensureAvatarColumn()">
                        üìã Verificar Columna Avatar
                    </button>
                    <div id="systemStatus" class="admin-status"></div>
                </div>
            </div>
        </section>
        
        <!-- Modal de Progreso -->
        <div class="modal-overlay" id="progressModal">
            <div class="modal-box modal-progress">
                <button class="modal-close-btn" id="progressCloseBtn" onclick="closeProgressModal()" style="display: none;">‚úï</button>
                <div class="modal-icon" id="progressIcon">‚è≥</div>
                <h3 class="modal-title" id="progressTitle">Generando Avatares 3D</h3>
                <p class="modal-text" id="progressText">Procesando pilotos...</p>
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progressPercent">0%</div>
                </div>
                
                <div class="progress-details" id="progressDetails"></div>
                <div id="avatarPreview" style="margin-top: 16px;"></div>
            </div>
        </section>
    </main>

    <!-- Modal de Confirmaci√≥n para Eliminar Cuenta -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <div class="modal-icon">‚ö†Ô∏è</div>
            <h3 class="modal-title">¬øEst√°s seguro?</h3>
            <p class="modal-text">Esta acci√≥n eliminar√° permanentemente tu cuenta, escuder√≠a y todos los datos asociados. No podr√°s recuperar esta informaci√≥n.</p>
            <p class="modal-subtext">Escribe <strong>ELIMINAR</strong> para confirmar:</p>
            <input type="text" id="deleteConfirmInput" class="modal-input" placeholder="Escribe ELIMINAR">
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="hideDeleteModal()">Cancelar</button>
                <button class="btn-confirm-delete" id="btnConfirmDelete" onclick="deleteAccount()" disabled>Eliminar Cuenta</button>
            </div>
        </div>
    </div>

    <script src="nav-menu.js"></script>
    <script>
        // Variable para verificar si es admin
        let isAdmin = false;
        
        // Cargar datos del usuario y verificar admin
        fetch('/api/user-data')
            .then(res => {
                if (!res.ok) {
                    window.location.href = '/index.html?error=login';
                    return null;
                }
                return res.json();
            })
            .then(data => {
                if (data) {
                    // Navbar m√≥vil
                    document.getElementById('userNameMobile').innerText = data.username;
                    document.getElementById('userTeamMobile').innerText = data.escuderia || 'Escuder√≠a';
                    document.getElementById('userBudgetMobile').innerText = new Intl.NumberFormat('de-DE').format(data.budget) + " ‚Ç¨";
                    document.getElementById('userAvatarMobile').innerText = data.username.charAt(0).toUpperCase();
                    // Formulario
                    document.getElementById('configUsername').value = data.username;
                    document.getElementById('configEmail').value = data.email || '';
                    document.getElementById('configEscuderia').value = data.escuderia || '';
                    // Idioma - seleccionar el valor correcto
                    document.getElementById('languageSelect').value = data.language || 'es';
                    // Notificaciones
                    if (data.notify_email !== undefined) document.getElementById('notifyEmail').checked = data.notify_email;
                    if (data.notify_races !== undefined) document.getElementById('notifyRaces').checked = data.notify_races;
                    if (data.notify_news !== undefined) document.getElementById('notifyNews').checked = data.notify_news;
                    
                    // Verificar si es admin y mostrar panel
                    if (data.isAdmin) {
                        isAdmin = true;
                        document.getElementById('adminSection').style.display = 'block';
                        console.log('[CONFIG] Usuario es admin, panel mostrado');
                        // Cargar estado de avatares
                        loadAvatarsStatus();
                    }
                }
            })
            .catch(() => {
                window.location.href = '/index.html?error=login';
            });

        // Guardar cambios de cuenta
        document.getElementById('btnSaveAccount').addEventListener('click', async () => {
            const username = document.getElementById('configUsername').value.trim();
            const email = document.getElementById('configEmail').value.trim();
            const escuderia = document.getElementById('configEscuderia').value.trim();
            const language = document.getElementById('languageSelect').value;
            const notifyEmail = document.getElementById('notifyEmail').checked;
            const notifyRaces = document.getElementById('notifyRaces').checked;
            const notifyNews = document.getElementById('notifyNews').checked;
            const messageEl = document.getElementById('saveMessage');

            console.log('[CONFIG] Iniciando guardado de cuenta con idioma:', language);

            if (!username || !email) {
                messageEl.textContent = '‚ùå El nombre de usuario y email son obligatorios';
                messageEl.className = 'form-message error';
                return;
            }

            let res;
            let data;

            // FASE 1: Guardar en servidor
            try {
                console.log('[CONFIG] Enviando petici√≥n al servidor...');
                res = await fetch('/api/update-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, escuderia, language, notifyEmail, notifyRaces, notifyNews })
                });
                console.log('[CONFIG] Respuesta recibida, status:', res.status);
            } catch (netErr) {
                console.error('[CONFIG] Error de red:', netErr);
                messageEl.textContent = '‚ùå Error de conexi√≥n con el servidor';
                messageEl.className = 'form-message error';
                return;
            }

            // FASE 2: Parsear respuesta JSON
            try {
                data = await res.json();
                console.log('[CONFIG] Datos del servidor:', data);
            } catch (parseErr) {
                console.error('[CONFIG] Error parseando JSON:', parseErr);
                messageEl.textContent = '‚ùå Error procesando respuesta del servidor';
                messageEl.className = 'form-message error';
                return;
            }

            // FASE 3: Procesar resultado
            if (res.ok && data.success) {
                messageEl.textContent = '‚úÖ Datos guardados correctamente';
                messageEl.className = 'form-message success';
                
                // Actualizar navbar
                try {
                    document.getElementById('userNameMobile').innerText = username;
                    document.getElementById('userTeamMobile').innerText = escuderia || 'Escuder√≠a';
                    document.documentElement.lang = language;
                } catch (navErr) {
                    console.warn('[CONFIG] Error actualizando navbar:', navErr);
                }
                
                // Recargar traducciones en segundo plano (no bloquea el √©xito)
                if (window.i18n && typeof window.i18n.loadTranslations === 'function') {
                    console.log('[CONFIG] Recargando traducciones para:', language);
                    window.i18n.loadTranslations(language).then(() => {
                        if (typeof window.i18n.applyTranslations === 'function') {
                            window.i18n.applyTranslations();
                        }
                        console.log('[CONFIG] Traducciones aplicadas');
                    }).catch(err => {
                        console.warn('[CONFIG] Traducciones no recargadas (no cr√≠tico):', err.message);
                    });
                }
            } else {
                // El servidor respondi√≥ con error
                messageEl.textContent = '‚ùå ' + (data.error || 'Error al guardar');
                messageEl.className = 'form-message error';
            }
        });

        // Solicitar cambio de contrase√±a
        document.getElementById('btnRequestPassword').addEventListener('click', async () => {
            const messageEl = document.getElementById('passwordMessage');

            try {
                const res = await fetch('/api/request-password-change', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await res.json();

                if (res.ok) {
                    messageEl.textContent = '‚úÖ Se ha enviado un enlace a tu correo electr√≥nico';
                    messageEl.className = 'form-message success';
                } else {
                    messageEl.textContent = '‚ùå ' + (data.error || 'Error al solicitar');
                    messageEl.className = 'form-message error';
                }
            } catch (err) {
                messageEl.textContent = '‚ùå Error de conexi√≥n';
                messageEl.className = 'form-message error';
            }
        });

        // Modal de eliminar cuenta
        const deleteModal = document.getElementById('deleteModal');
        const deleteInput = document.getElementById('deleteConfirmInput');
        const btnConfirmDelete = document.getElementById('btnConfirmDelete');

        function showDeleteConfirm() {
            deleteModal.classList.add('active');
            deleteInput.value = '';
            btnConfirmDelete.disabled = true;
        }

        function hideDeleteModal() {
            deleteModal.classList.remove('active');
        }

        deleteInput.addEventListener('input', (e) => {
            btnConfirmDelete.disabled = e.target.value !== 'ELIMINAR';
        });

        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                hideDeleteModal();
            }
        });

        function deleteAccount() {
            if (deleteInput.value !== 'ELIMINAR') return;
            alert('Funci√≥n de eliminaci√≥n de cuenta - pendiente de implementar en el servidor');
        }
        
        // ========================================
        // SISTEMA DE AVATARES 3D CON THREE.JS
        // ========================================
        
        let THREE = null;
        let avatarScene = null;
        let avatarCamera = null;
        let avatarRenderer = null;
        
        // Cargar Three.js din√°micamente
        async function loadThreeJS() {
            if (THREE) return;
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/three@0.160.0/build/three.min.js';
                script.onload = () => {
                    THREE = window.THREE;
                    console.log('[AVATAR] Three.js cargado');
                    resolve();
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // Inicializar escena 3D
        function initThreeScene() {
            if (avatarScene) return;
            
            // Escena
            avatarScene = new THREE.Scene();
            avatarScene.background = null;
            
            // C√°mara ortogr√°fica para vista frontal
            const aspect = 1;
            const frustumSize = 2.5;
            avatarCamera = new THREE.OrthographicCamera(
                frustumSize * aspect / -2,
                frustumSize * aspect / 2,
                frustumSize / 2,
                frustumSize / -2,
                0.1, 100
            );
            avatarCamera.position.set(0, 0, 5);
            avatarCamera.lookAt(0, 0, 0);
            
            // Renderer con alpha para fondo transparente
            avatarRenderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true,
                preserveDrawingBuffer: true 
            });
            avatarRenderer.setSize(256, 256);
            avatarRenderer.setPixelRatio(1);
            avatarRenderer.shadowMap.enabled = true;
            avatarRenderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // Iluminaci√≥n tipo estudio fotogr√°fico
            // Key light (luz principal)
            const keyLight = new THREE.DirectionalLight(0xffffff, 1.2);
            keyLight.position.set(2, 3, 5);
            keyLight.castShadow = true;
            avatarScene.add(keyLight);
            
            // Fill light (luz de relleno)
            const fillLight = new THREE.DirectionalLight(0xffffff, 0.6);
            fillLight.position.set(-3, 1, 3);
            avatarScene.add(fillLight);
            
            // Rim/back light (luz de contorno)
            const rimLight = new THREE.DirectionalLight(0xffffff, 0.4);
            rimLight.position.set(0, 2, -3);
            avatarScene.add(rimLight);
            
            // Luz ambiental suave
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
            avatarScene.add(ambientLight);
            
            console.log('[AVATAR] Escena 3D inicializada');
        }
        
        // Generador determinista
        class SeededRandom {
            constructor(seed) {
                this.seed = seed;
            }
            next() {
                this.seed = (this.seed * 9301 + 49297) % 233280;
                return this.seed / 233280;
            }
            range(min, max) {
                return min + this.next() * (max - min);
            }
            int(min, max) {
                return Math.floor(this.range(min, max + 1));
            }
        }
        
        // Crear avatar 3D para un piloto
        function createAvatar3D(piloto) {
            const rng = new SeededRandom(piloto.id * 1000);
            const edad = piloto.edad || 25;
            const peso = piloto.peso || 70;
            
            // Limpiar escena
            while (avatarScene.children.length > 4) {
                const obj = avatarScene.children[avatarScene.children.length - 1];
                avatarScene.remove(obj);
                if (obj.geometry) obj.geometry.dispose();
                if (obj.material) {
                    if (Array.isArray(obj.material)) {
                        obj.material.forEach(m => m.dispose());
                    } else {
                        obj.material.dispose();
                    }
                }
            }
            
            const group = new THREE.Group();
            
            // Colores de piel
            const skinColors = [0xf5d0c5, 0xe8beac, 0xd4a574, 0xc68642, 0x8d5524, 0xf1c27d, 0xffdbac, 0xc9a66b];
            const skinColor = skinColors[rng.int(0, skinColors.length - 1)];
            
            // Factor de peso para forma de cara
            const weightFactor = (peso - 70) / 30;
            const faceWidth = 1 + weightFactor * 0.12;
            const faceHeight = 1.15 - weightFactor * 0.03;
            
            // === CABEZA ===
            const headGeometry = new THREE.SphereGeometry(0.85, 48, 48);
            headGeometry.scale(faceWidth, faceHeight, 0.9);
            
            const headMaterial = new THREE.MeshStandardMaterial({
                color: skinColor,
                roughness: 0.7,
                metalness: 0.0
            });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.castShadow = true;
            head.receiveShadow = true;
            group.add(head);
            
            // === CUELLO ===
            const neckGeometry = new THREE.CylinderGeometry(0.28, 0.32, 0.35, 24);
            const neck = new THREE.Mesh(neckGeometry, headMaterial);
            neck.position.y = -0.95;
            neck.castShadow = true;
            group.add(neck);
            
            // === OREJAS ===
            const earGeometry = new THREE.SphereGeometry(0.12, 16, 16);
            earGeometry.scale(0.5, 1, 0.7);
            
            const leftEar = new THREE.Mesh(earGeometry, headMaterial);
            leftEar.position.set(-0.85 * faceWidth, 0.05, 0);
            leftEar.rotation.y = -0.2;
            group.add(leftEar);
            
            const rightEar = new THREE.Mesh(earGeometry, headMaterial);
            rightEar.position.set(0.85 * faceWidth, 0.05, 0);
            rightEar.rotation.y = 0.2;
            group.add(rightEar);
            
            // === OJOS ===
            const eyeWhiteMaterial = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.3 });
            const eyeColors = [0x4a3728, 0x5d4037, 0x3e2723, 0x1a237e, 0x0d47a1, 0x2e7d32];
            const irisColor = eyeColors[rng.int(0, eyeColors.length - 1)];
            const irisMaterial = new THREE.MeshStandardMaterial({ color: irisColor, roughness: 0.2 });
            const pupilMaterial = new THREE.MeshStandardMaterial({ color: 0x000000, roughness: 0.1 });
            
            // P√°rpados
            const eyelidMaterial = new THREE.MeshStandardMaterial({ color: skinColor, roughness: 0.8 });
            
            [-0.28, 0.28].forEach((xPos, idx) => {
                // Cuenco del ojo
                const eyeSocket = new THREE.SphereGeometry(0.14, 24, 24);
                const socket = new THREE.Mesh(eyeSocket, headMaterial);
                socket.position.set(xPos, 0.12, 0.72);
                socket.scale.set(1, 0.7, 0.5);
                group.add(socket);
                
                // Blanco del ojo
                const eyeWhiteGeom = new THREE.SphereGeometry(0.11, 24, 24);
                const eyeWhite = new THREE.Mesh(eyeWhiteGeom, eyeWhiteMaterial);
                eyeWhite.position.set(xPos, 0.12, 0.76);
                group.add(eyeWhite);
                
                // Iris
                const irisGeom = new THREE.SphereGeometry(0.07, 24, 24);
                const iris = new THREE.Mesh(irisGeom, irisMaterial);
                iris.position.set(xPos, 0.12, 0.85);
                group.add(iris);
                
                // Pupila
                const pupilGeom = new THREE.SphereGeometry(0.035, 16, 16);
                const pupil = new THREE.Mesh(pupilGeom, pupilMaterial);
                pupil.position.set(xPos, 0.12, 0.9);
                group.add(pupil);
                
                // Brillo
                const shineGeom = new THREE.SphereGeometry(0.018, 8, 8);
                const shineMaterial = new THREE.MeshBasicMaterial({ color: 0xffffff });
                const shine = new THREE.Mesh(shineGeom, shineMaterial);
                shine.position.set(xPos + 0.025, 0.135, 0.92);
                group.add(shine);
                
                // P√°rpado superior
                const eyelidGeom = new THREE.SphereGeometry(0.13, 24, 12, 0, Math.PI * 2, 0, Math.PI / 2);
                const eyelid = new THREE.Mesh(eyelidGeom, eyelidMaterial);
                eyelid.position.set(xPos, 0.12, 0.74);
                eyelid.rotation.x = Math.PI;
                group.add(eyelid);
            });
            
            // === CEJAS ===
            const eyebrowColor = edad >= 50 ? 0x808080 : 0x3e2723;
            const eyebrowMaterial = new THREE.MeshStandardMaterial({ color: eyebrowColor, roughness: 0.9 });
            
            const eyebrowGeom = new THREE.BoxGeometry(0.18, 0.04, 0.06);
            const leftEyebrow = new THREE.Mesh(eyebrowGeom, eyebrowMaterial);
            leftEyebrow.position.set(-0.28, 0.32, 0.78);
            leftEyebrow.rotation.z = 0.1;
            group.add(leftEyebrow);
            
            const rightEyebrow = new THREE.Mesh(eyebrowGeom, eyebrowMaterial);
            rightEyebrow.position.set(0.28, 0.32, 0.78);
            rightEyebrow.rotation.z = -0.1;
            group.add(rightEyebrow);
            
            // === NARIZ ===
            const noseGroup = new THREE.Group();
            
            // Puente de la nariz
            const noseBridgeGeom = new THREE.BoxGeometry(0.08, 0.22, 0.15);
            const noseBridge = new THREE.Mesh(noseBridgeGeom, headMaterial);
            noseBridge.position.set(0, 0, 0.75);
            noseGroup.add(noseBridge);
            
            // Punta de la nariz
            const noseTipGeom = new THREE.SphereGeometry(0.08, 16, 16);
            const noseTip = new THREE.Mesh(noseTipGeom, headMaterial);
            noseTip.position.set(0, -0.12, 0.82);
            noseTip.scale.set(1, 0.7, 0.8);
            noseGroup.add(noseTip);
            
            // Alares (laterales de la nariz)
            const nostrilGeom = new THREE.SphereGeometry(0.045, 12, 12);
            const leftNostril = new THREE.Mesh(nostrilGeom, headMaterial);
            leftNostril.position.set(-0.06, -0.15, 0.78);
            noseGroup.add(leftNostril);
            
            const rightNostril = new THREE.Mesh(nostrilGeom, headMaterial);
            rightNostril.position.set(0.06, -0.15, 0.78);
            noseGroup.add(rightNostril);
            
            group.add(noseGroup);
            
            // === BOCA ===
            const lipColor = 0xc17f7f;
            const lipMaterial = new THREE.MeshStandardMaterial({ color: lipColor, roughness: 0.4 });
            
            // Labio superior
            const upperLipGeom = new THREE.TorusGeometry(0.08, 0.02, 8, 16, Math.PI);
            const upperLip = new THREE.Mesh(upperLipGeom, lipMaterial);
            upperLip.position.set(0, -0.38, 0.75);
            upperLip.rotation.x = Math.PI;
            upperLip.scale.set(1.4, 1, 1);
            group.add(upperLip);
            
            // Labio inferior
            const lowerLipGeom = new THREE.TorusGeometry(0.09, 0.025, 8, 16, Math.PI);
            const lowerLip = new THREE.Mesh(lowerLipGeom, lipMaterial);
            lowerLip.position.set(0, -0.45, 0.72);
            lowerLip.scale.set(1.3, 1, 0.8);
            group.add(lowerLip);
            
            // === PELO ===
            addHair3D(group, rng, edad, faceWidth, faceHeight, THREE);
            
            // === GAFAS (seg√∫n edad) ===
            if (edad >= 35 && rng.next() < (edad - 30) * 0.025) {
                addGlasses3D(group, rng, THREE);
            }
            
            // === MEJILLAS (si peso alto) ===
            if (peso > 80) {
                const cheekSize = 0.1 + (peso - 80) * 0.003;
                const cheekGeom = new THREE.SphereGeometry(cheekSize, 16, 16);
                
                const leftCheek = new THREE.Mesh(cheekGeom, headMaterial);
                leftCheek.position.set(-0.4, -0.15, 0.65);
                leftCheek.scale.set(1.2, 0.8, 0.6);
                group.add(leftCheek);
                
                const rightCheek = new THREE.Mesh(cheekGeom, headMaterial);
                rightCheek.position.set(0.4, -0.15, 0.65);
                rightCheek.scale.set(1.2, 0.8, 0.6);
                group.add(rightCheek);
            }
            
            // A√±adir a escena y renderizar
            avatarScene.add(group);
            avatarRenderer.render(avatarScene, avatarCamera);
            
            // Obtener imagen como base64
            const dataUrl = avatarRenderer.domElement.toDataURL('image/png');
            
            // Limpiar
            avatarScene.remove(group);
            
            return dataUrl;
        }
        
        // A√±adir pelo 3D
        function addHair3D(group, rng, edad, faceWidth, faceHeight, THREE) {
            // Color de pelo seg√∫n edad
            let hairColor;
            if (edad >= 50) {
                hairColor = rng.next() < 0.7 ? 0xc0c0c0 : 0x808080;
            } else if (edad >= 40) {
                hairColor = rng.next() < 0.4 ? 0x808080 : 0x3e2723;
            } else if (edad >= 30) {
                const colors = [0x3e2723, 0x5d4037, 0x4a3728, 0x1a1a1a, 0x8d5524];
                hairColor = rng.next() < 0.15 ? 0x808080 : colors[rng.int(0, colors.length - 1)];
            } else {
                const colors = [0x3e2723, 0x5d4037, 0x4a3728, 0x1a1a1a, 0x8d5524, 0xd4a574];
                hairColor = colors[rng.int(0, colors.length - 1)];
            }
            
            const hairMaterial = new THREE.MeshStandardMaterial({ 
                color: hairColor, 
                roughness: 0.8,
                metalness: 0.1
            });
            
            // Calvicie seg√∫n edad
            const baldProb = edad >= 45 ? 0.3 : (edad >= 35 ? 0.15 : 0.02);
            const isBald = rng.next() < baldProb;
            
            if (isBald && edad >= 35) {
                // Pelo lateral para calvos
                const sideGeom = new THREE.SphereGeometry(0.25, 16, 16);
                
                const leftSide = new THREE.Mesh(sideGeom, hairMaterial);
                leftSide.position.set(-0.65 * faceWidth, 0.45, 0);
                leftSide.scale.set(0.4, 0.6, 0.3);
                group.add(leftSide);
                
                const rightSide = new THREE.Mesh(sideGeom, hairMaterial);
                rightSide.position.set(0.65 * faceWidth, 0.45, 0);
                rightSide.scale.set(0.4, 0.6, 0.3);
                group.add(rightSide);
                
                return;
            }
            
            // Base del pelo
            const hairBaseGeom = new THREE.SphereGeometry(0.88, 48, 24, 0, Math.PI * 2, 0, Math.PI / 2);
            const hairBase = new THREE.Mesh(hairBaseGeom, hairMaterial);
            hairBase.position.y = 0.08 * faceHeight;
            hairBase.scale.set(faceWidth, 0.5, 0.95);
            group.add(hairBase);
            
            // Volumen adicional seg√∫n estilo
            const hairStyle = rng.int(0, 4);
            
            switch (hairStyle) {
                case 0: // Pelo corto
                    break;
                    
                case 1: // Flequillo
                    const bangGeom = new THREE.BoxGeometry(0.45 * faceWidth, 0.12, 0.18);
                    const bang = new THREE.Mesh(bangGeom, hairMaterial);
                    bang.position.set(0, 0.55 * faceHeight, 0.6);
                    group.add(bang);
                    break;
                    
                case 2: // Pelo hacia atr√°s
                    const backGeom = new THREE.SphereGeometry(0.5, 24, 16);
                    const backHair = new THREE.Mesh(backGeom, hairMaterial);
                    backHair.position.set(0, 0.5 * faceHeight, -0.25);
                    backHair.scale.set(faceWidth * 0.9, 0.35, 0.6);
                    group.add(backHair);
                    break;
                    
                case 3: // Pelo lateral
                    const sidePartGeom = new THREE.BoxGeometry(0.25, 0.18, 0.22);
                    const sidePart = new THREE.Mesh(sidePartGeom, hairMaterial);
                    sidePart.position.set(-0.32 * faceWidth, 0.52 * faceHeight, 0.5);
                    sidePart.rotation.z = -0.15;
                    group.add(sidePart);
                    break;
                    
                case 4: // Rapado
                    hairBase.material = new THREE.MeshStandardMaterial({ 
                        color: hairColor, 
                        roughness: 0.9,
                        metalness: 0.0,
                        transparent: true,
                        opacity: 0.7
                    });
                    hairBase.scale.set(faceWidth, 0.2, 0.9);
                    break;
            }
            
            // A√±adir mechones para m√°s volumen
            if (hairStyle < 4 && rng.next() > 0.5) {
                const strandGeom = new THREE.SphereGeometry(0.08, 8, 8);
                for (let i = 0; i < 3; i++) {
                    const strand = new THREE.Mesh(strandGeom, hairMaterial);
                    strand.position.set(
                        rng.range(-0.3, 0.3) * faceWidth,
                        0.6 * faceHeight + rng.range(0, 0.1),
                        rng.range(0.3, 0.6)
                    );
                    strand.scale.set(1.5, 1, 0.8);
                    group.add(strand);
                }
            }
        }
        
        // A√±adir gafas 3D
        function addGlasses3D(group, rng, THREE) {
            const frameMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x1a1a1a, 
                roughness: 0.3,
                metalness: 0.5 
            });
            const lensMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x87ceeb, 
                transparent: true, 
                opacity: 0.25,
                roughness: 0.1,
                metalness: 0.1
            });
            
            // Marcos redondos
            const frameGeom = new THREE.TorusGeometry(0.14, 0.012, 8, 24);
            
            const leftFrame = new THREE.Mesh(frameGeom, frameMaterial);
            leftFrame.position.set(-0.28, 0.1, 0.85);
            group.add(leftFrame);
            
            const rightFrame = new THREE.Mesh(frameGeom, frameMaterial);
            rightFrame.position.set(0.28, 0.1, 0.85);
            group.add(rightFrame);
            
            // Lentes
            const lensGeom = new THREE.CircleGeometry(0.125, 24);
            
            const leftLens = new THREE.Mesh(lensGeom, lensMaterial);
            leftLens.position.set(-0.28, 0.1, 0.84);
            group.add(leftLens);
            
            const rightLens = new THREE.Mesh(lensGeom, lensMaterial);
            rightLens.position.set(0.28, 0.1, 0.84);
            group.add(rightLens);
            
            // Puente
            const bridgeGeom = new THREE.CylinderGeometry(0.01, 0.01, 0.1, 8);
            const bridge = new THREE.Mesh(bridgeGeom, frameMaterial);
            bridge.position.set(0, 0.1, 0.88);
            bridge.rotation.z = Math.PI / 2;
            group.add(bridge);
            
            // Patillas
            const templeGeom = new THREE.BoxGeometry(0.015, 0.015, 0.35);
            
            const leftTemple = new THREE.Mesh(templeGeom, frameMaterial);
            leftTemple.position.set(-0.42, 0.1, 0.65);
            group.add(leftTemple);
            
            const rightTemple = new THREE.Mesh(templeGeom, frameMaterial);
            rightTemple.position.set(0.42, 0.1, 0.65);
            group.add(rightTemple);
        }
        
        // ========================================
        // FUNCIONES DE ADMINISTRADOR
        // ========================================
        
        // Cargar estado de avatares al iniciar
        async function loadAvatarsStatus() {
            if (!isAdmin) return;
            
            try {
                const res = await fetch('/api/admin/avatars-status');
                const data = await res.json();
                
                const statusInfo = document.getElementById('avatarStatusInfo');
                if (data.total === 0) {
                    statusInfo.innerHTML = '<span style="color: #888;">‚ÑπÔ∏è No hay pilotos en la base de datos</span>';
                } else if (data.todosCompletos) {
                    statusInfo.innerHTML = `<span style="color: #00c853;">‚úÖ Todos los avatares est√°n generados (${data.total}/${data.total})</span>`;
                } else {
                    statusInfo.innerHTML = `<span style="color: #ff9800;">‚ö†Ô∏è Avatares pendientes: ${data.sinAvatar} de ${data.total}</span>`;
                }
            } catch (err) {
                console.error('Error cargando estado de avatares:', err);
            }
        }
        
        // Verificar y generar avatares
        async function checkAndGenerateAvatars() {
            const btn = document.getElementById('btnGenerateAvatars');
            btn.disabled = true;
            
            try {
                // Cargar Three.js
                showProgressModal({
                    type: 'loading',
                    title: 'Cargando Three.js',
                    text: 'Preparando motor 3D...'
                });
                
                await loadThreeJS();
                initThreeScene();
                
                // Verificar estado actual
                const statusRes = await fetch('/api/admin/avatars-status');
                const statusData = await statusRes.json();
                
                if (statusData.todosCompletos) {
                    showProgressModal({
                        type: 'warning',
                        title: 'Avatares ya generados',
                        text: `Todos los ${statusData.total} pilotos ya tienen avatar. ¬øQuieres regenerarlos todos?`,
                        showClose: true
                    });
                    btn.disabled = false;
                    return;
                }
                
                if (statusData.total === 0) {
                    showProgressModal({
                        type: 'info',
                        title: 'Sin pilotos',
                        text: 'No hay pilotos en la base de datos para generar avatares.',
                        showClose: true
                    });
                    btn.disabled = false;
                    return;
                }
                
                // Obtener lista de pilotos
                showProgressModal({
                    type: 'loading',
                    title: 'Generando Avatares 3D',
                    text: `Preparando ${statusData.sinAvatar} avatares...`,
                    total: statusData.sinAvatar,
                    current: 0
                });
                
                // Obtener pilotos sin avatar
                const pilotosRes = await fetch('/api/admin/pilotos-sin-avatar');
                const pilotos = await pilotosRes.json();
                
                if (!pilotos.length) {
                    showProgressModal({
                        type: 'info',
                        title: 'Sin cambios',
                        text: 'Todos los pilotos ya tienen avatar.',
                        showClose: true
                    });
                    btn.disabled = false;
                    return;
                }
                
                // Generar avatares uno por uno
                let processed = 0;
                const total = pilotos.length;
                const errors = [];
                
                for (const piloto of pilotos) {
                    try {
                        // Actualizar UI
                        updateProgress(processed, total, piloto.nombre);
                        
                        // Generar avatar 3D
                        const avatarData = createAvatar3D(piloto);
                        
                        // Guardar en servidor
                        const saveRes = await fetch('/api/admin/save-avatar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                pilotoId: piloto.id, 
                                avatar: avatarData 
                            })
                        });
                        
                        if (!saveRes.ok) {
                            throw new Error('Error al guardar');
                        }
                        
                        // Mostrar preview
                        if (processed === 0) {
                            document.getElementById('avatarPreview').innerHTML = 
                                `<img src="${avatarData}" style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid #ffc107;">`;
                        }
                        
                    } catch (err) {
                        errors.push(`${piloto.nombre}: ${err.message}`);
                    }
                    
                    processed++;
                }
                
                // Completar
                completeProgress({
                    updated: processed,
                    total: total,
                    errors: errors
                });
                
                // Recargar estado
                await loadAvatarsStatus();
                
            } catch (err) {
                showProgressModal({
                    type: 'error',
                    title: 'Error',
                    text: err.message,
                    showClose: true
                });
            } finally {
                btn.disabled = false;
            }
        }
        
        // Actualizar progreso
        function updateProgress(current, total, nombre) {
            const percent = Math.round(((current + 1) / total) * 100);
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressDetails').innerHTML = 
                `<span style="color: #ffc107;">Procesando: ${current + 1}/${total}</span><br>
                 <span style="color: #fff; font-size: 12px;">${nombre}</span>`;
        }
        
        // Completar progreso
        function completeProgress(data) {
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            const progressDetails = document.getElementById('progressDetails');
            const progressTitle = document.getElementById('progressTitle');
            const progressText = document.getElementById('progressText');
            const progressIcon = document.getElementById('progressIcon');
            const progressCloseBtn = document.getElementById('progressCloseBtn');
            
            progressFill.style.width = '100%';
            progressPercent.textContent = '100%';
            progressFill.style.background = 'linear-gradient(90deg, #00c853, #69f0ae)';
            
            progressIcon.textContent = '‚úÖ';
            progressTitle.textContent = '¬°Proceso Completado!';
            progressText.textContent = `Se generaron ${data.updated} avatares 3D correctamente.`;
            
            if (data.errors && data.errors.length > 0) {
                progressDetails.innerHTML = `
                    <span style="color: #ff9800;">‚ö†Ô∏è ${data.errors.length} errores:</span>
                    <div style="font-size: 11px; color: #888; margin-top: 8px; max-height: 60px; overflow-y: auto;">
                        ${data.errors.map(e => `<div>‚Ä¢ ${e}</div>`).join('')}
                    </div>
                `;
            } else {
                progressDetails.innerHTML = '<span style="color: #00c853;">‚ú® Todos los avatares generados sin errores</span>';
            }
            
            progressCloseBtn.style.display = 'block';
        }
        
        // Mostrar modal de progreso
        function showProgressModal(options) {
            const modal = document.getElementById('progressModal');
            const progressIcon = document.getElementById('progressIcon');
            const progressTitle = document.getElementById('progressTitle');
            const progressText = document.getElementById('progressText');
            const progressContainer = document.getElementById('progressContainer');
            const progressDetails = document.getElementById('progressDetails');
            const progressCloseBtn = document.getElementById('progressCloseBtn');
            const progressFill = document.getElementById('progressFill');
            const avatarPreview = document.getElementById('avatarPreview');
            
            progressFill.style.width = '0%';
            progressFill.style.background = 'linear-gradient(90deg, #ffc107, #ff9800)';
            document.getElementById('progressPercent').textContent = '0%';
            progressCloseBtn.style.display = options.showClose ? 'block' : 'none';
            progressDetails.innerHTML = '';
            avatarPreview.innerHTML = '';
            
            switch(options.type) {
                case 'warning':
                    progressIcon.textContent = '‚ö†Ô∏è';
                    progressContainer.style.display = 'none';
                    break;
                case 'error':
                    progressIcon.textContent = '‚ùå';
                    progressContainer.style.display = 'none';
                    break;
                case 'info':
                    progressIcon.textContent = '‚ÑπÔ∏è';
                    progressContainer.style.display = 'none';
                    break;
                case 'loading':
                    progressIcon.textContent = '‚è≥';
                    progressContainer.style.display = 'block';
                    break;
                default:
                    progressContainer.style.display = 'none';
            }
            
            progressTitle.textContent = options.title || 'Procesando';
            progressText.textContent = options.text || '';
            
            modal.classList.add('active');
        }
        
        // Cerrar modal de progreso
        function closeProgressModal() {
            document.getElementById('progressModal').classList.remove('active');
        }
        
        // Cerrar al hacer clic fuera
        document.getElementById('progressModal').addEventListener('click', (e) => {
            if (e.target.id === 'progressModal') {
                closeProgressModal();
            }
        });
        
        async function ensureAvatarColumn() {
            const statusEl = document.getElementById('systemStatus');
            const btn = document.getElementById('btnEnsureAvatarColumn');
            
            statusEl.innerHTML = '<span class="loading">‚è≥ Verificando...</span>';
            btn.disabled = true;
            
            try {
                const res = await fetch('/api/admin/ensure-avatar-column', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    statusEl.innerHTML = `<span class="success">‚úÖ ${data.message}</span>`;
                } else {
                    statusEl.innerHTML = `<span class="error">‚ùå ${data.error || 'Error desconocido'}</span>`;
                }
            } catch (err) {
                statusEl.innerHTML = `<span class="error">‚ùå Error de conexi√≥n: ${err.message}</span>`;
            } finally {
                btn.disabled = false;
            }
        }
    </script>
    <style>
        /* Estilos del panel de administrador */
        .config-admin {
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid rgba(255, 193, 7, 0.3);
        }
        
        .config-title-admin {
            color: #ffc107;
        }
        
        .admin-tools {
            display: grid;
            gap: 20px;
            margin-top: 16px;
        }
        
        .admin-tool {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        .admin-tool h3 {
            margin: 0 0 8px 0;
            color: #fff;
            font-size: 16px;
        }
        
        .admin-tool p {
            margin: 0 0 16px 0;
            color: #aaa;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .btn-admin {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }
        
        .btn-admin:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-admin.btn-secondary {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        .btn-admin.btn-secondary:hover {
            background: rgba(255, 193, 7, 0.3);
        }
        
        .admin-status {
            margin-top: 12px;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .admin-status .loading {
            color: #ffc107;
        }
        
        .admin-status .success {
            color: #00c853;
        }
        
        .admin-status .error {
            color: #f44336;
        }
        
        /* Modal de progreso */
        .modal-progress {
            max-width: 400px;
            text-align: center;
        }
        
        .modal-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #888;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .modal-close-btn:hover {
            background: rgba(255, 87, 34, 0.3);
            color: #ff5722;
        }
        
        .modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .modal-title {
            font-size: 20px;
            margin: 0 0 8px 0;
            color: #fff;
        }
        
        .modal-text {
            font-size: 14px;
            color: #aaa;
            margin: 0 0 20px 0;
        }
        
        .progress-container {
            margin-bottom: 16px;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffc107, #ff9800);
            border-radius: 6px;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 14px;
            color: #fff;
            font-weight: bold;
        }
        
        .progress-details {
            font-size: 13px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-top: 12px;
        }
        
        .admin-status-info {
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 13px;
        }
    </style>
<script src="preload-fondos.js"></script>
</body>
</html>
