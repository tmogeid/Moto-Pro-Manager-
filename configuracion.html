<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="config.title">Settings | Moto Pro Manager</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="cookie-consent.js"></script>
    <script src="background-changer.js"></script>
    <script src="js/i18n.js"></script>
</head>
<body class="paddock-page">
    <!-- NAVBAR -->
    <nav class="nav-mobile">
        <div class="nav-mobile-bar">
            <div class="nav-logo">
                <img src="favicon.png" alt="Logo" class="nav-logo-img-mobile">
                <span class="nav-page-title" data-i18n="config.title">ConfiguraciÃ³n</span>
            </div>
            <button class="hamburger" id="hamburgerBtn" aria-label="MenÃº">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
        </div>
    </nav>

    <!-- OVERLAY -->
    <div class="nav-overlay" id="navOverlay"></div>

    <!-- MENÃš DESPLEGABLE -->
    <div class="nav-mobile-menu" id="navMobileMenu">
        <a href="/paddock" class="nav-mobile-link">ğŸ <span data-i18n="paddock.title">Paddock</span></a>
        <div class="nav-mobile-dropdown">
            <button class="nav-mobile-dropdown-toggle" id="garajeToggle">
                ğŸï¸ Garaje
                <span class="dropdown-arrow">â–¼</span>
            </button>
            <div class="nav-mobile-dropdown-menu" id="garajeDropdown">
                <a href="/piloto" class="nav-mobile-link nav-mobile-sub">ğŸ‘¤ Pilotos</a>
                <a href="/moto" class="nav-mobile-link nav-mobile-sub">ğŸï¸ Moto</a>
            </div>
        </div>
        <a href="/configuracion" class="nav-mobile-link">âš™ï¸ <span data-i18n="config.title">ConfiguraciÃ³n</span></a>
        <a href="/logout" class="nav-mobile-link nav-mobile-logout">ğŸšª <span data-i18n="paddock.logout">Cerrar SesiÃ³n</span></a>
        <div class="nav-mobile-user">
            <div class="nav-user-avatar" id="userAvatarMobile">U</div>
            <div>
                <div class="nav-user-name" id="userNameMobile">...</div>
                <div class="nav-user-team" id="userTeamMobile">EscuderÃ­a</div>
                <div class="nav-user-money" id="userBudgetMobile">0 â‚¬</div>
            </div>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="paddock-main">
        <!-- Mi Cuenta -->
        <section class="config-section">
            <h2 class="config-title">ğŸ‘¤ <span data-i18n="config.myAccount">Mi Cuenta</span></h2>
            <div class="config-form">
                <div class="form-group">
                    <label data-i18n="config.username">Nombre de usuario</label>
                    <input type="text" id="configUsername" placeholder="Usuario">
                </div>
                <div class="form-group">
                    <label data-i18n="config.email">Email</label>
                    <input type="email" id="configEmail" placeholder="usuario@email.com">
                </div>
                <div class="form-group">
                    <label data-i18n="config.teamName">Nombre de la escuderÃ­a</label>
                    <input type="text" id="configEscuderia" placeholder="EscuderÃ­a Pro">
                </div>
                <div class="form-group">
                    <label data-i18n="config.language">Idioma</label>
                    <select id="languageSelect" class="config-select">
                        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                        <option value="eslat">ğŸŒ EspaÃ±ol Latino</option>
                        <option value="en">ğŸ‡¬ğŸ‡§ English</option>
                        <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
                        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                        <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
                        <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                        <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                        <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                    </select>
                </div>

                <!-- Notificaciones -->
                <div class="form-group">
                    <label data-i18n="config.notifications">Notificaciones</label>
                    <div class="toggle-list-inline">
                        <label class="toggle-item">
                            <span data-i18n="config.emailNotifications">Email</span>
                            <input type="checkbox" id="notifyEmail" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-item">
                            <span data-i18n="config.raceNotifications">Carreras</span>
                            <input type="checkbox" id="notifyRaces" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-item">
                            <span data-i18n="config.newsNotifications">Noticias</span>
                            <input type="checkbox" id="notifyNews">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <button class="btn-save" id="btnSaveAccount" data-i18n="config.saveChanges">Guardar Cambios</button>
                <div id="saveMessage" class="form-message"></div>
            </div>
        </section>

        <!-- Cambiar ContraseÃ±a -->
        <section class="config-section">
            <h2 class="config-title">ğŸ” <span data-i18n="config.changePassword">Cambiar ContraseÃ±a</span></h2>
            <p class="config-description" data-i18n="config.passwordDesc">Si deseas cambiar tu contraseÃ±a, te enviaremos un enlace a tu correo electrÃ³nico.</p>
            <button class="btn-save btn-secondary" id="btnRequestPassword" data-i18n="config.requestPassword">Solicitar Cambio de ContraseÃ±a</button>
            <div id="passwordMessage" class="form-message"></div>
        </section>

        <!-- Zona Peligrosa - Eliminar Cuenta -->
        <section class="config-section config-danger">
            <h2 class="config-title config-title-danger">âš ï¸ <span data-i18n="config.dangerZone">Zona Peligrosa</span></h2>
            <p class="config-danger-text" data-i18n="config.dangerText">Estas acciones son irreversibles. AsegÃºrate de saber lo que estÃ¡s haciendo.</p>
            <button class="btn-danger" onclick="showDeleteConfirm()">ğŸ—‘ï¸ <span data-i18n="config.deleteAccount">Eliminar Mi Cuenta</span></button>
        </section>
    </main>

    <!-- Modal de ConfirmaciÃ³n para Eliminar Cuenta -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <div class="modal-icon">âš ï¸</div>
            <h3 class="modal-title">Â¿EstÃ¡s seguro?</h3>
            <p class="modal-text">Esta acciÃ³n eliminarÃ¡ permanentemente tu cuenta, escuderÃ­a y todos los datos asociados. No podrÃ¡s recuperar esta informaciÃ³n.</p>
            <p class="modal-subtext">Escribe <strong>ELIMINAR</strong> para confirmar:</p>
            <input type="text" id="deleteConfirmInput" class="modal-input" placeholder="Escribe ELIMINAR">
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="hideDeleteModal()">Cancelar</button>
                <button class="btn-confirm-delete" id="btnConfirmDelete" onclick="deleteAccount()" disabled>Eliminar Cuenta</button>
            </div>
        </div>
    </div>

    <script>
        // MenÃº hamburguesa
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const navOverlay = document.getElementById('navOverlay');
        const navMobileMenu = document.getElementById('navMobileMenu');

        hamburgerBtn.addEventListener('click', () => {
            hamburgerBtn.classList.toggle('active');
            navOverlay.classList.toggle('active');
            navMobileMenu.classList.toggle('active');
        });

        navOverlay.addEventListener('click', () => {
            hamburgerBtn.classList.remove('active');
            navOverlay.classList.remove('active');
            navMobileMenu.classList.remove('active');
        });

        // Toggle del dropdown Garaje en mÃ³vil
        const garajeToggle = document.getElementById('garajeToggle');
        const garajeDropdown = document.getElementById('garajeDropdown');
        
        garajeToggle.addEventListener('click', () => {
            garajeDropdown.classList.toggle('show');
            garajeToggle.classList.toggle('active');
        });

        // Cargar datos del usuario
        fetch('/api/user-data')
            .then(res => {
                if (!res.ok) {
                    window.location.href = '/index.html?error=login';
                    return null;
                }
                return res.json();
            })
            .then(data => {
                if (data) {
                    // Navbar mÃ³vil
                    document.getElementById('userNameMobile').innerText = data.username;
                    document.getElementById('userTeamMobile').innerText = data.escuderia || 'EscuderÃ­a';
                    document.getElementById('userBudgetMobile').innerText = new Intl.NumberFormat('de-DE').format(data.budget) + " â‚¬";
                    document.getElementById('userAvatarMobile').innerText = data.username.charAt(0).toUpperCase();
                    // Formulario
                    document.getElementById('configUsername').value = data.username;
                    document.getElementById('configEmail').value = data.email || '';
                    document.getElementById('configEscuderia').value = data.escuderia || '';
                    // Idioma - seleccionar el valor correcto
                    document.getElementById('languageSelect').value = data.language || 'es';
                    // Notificaciones
                    if (data.notify_email !== undefined) document.getElementById('notifyEmail').checked = data.notify_email;
                    if (data.notify_races !== undefined) document.getElementById('notifyRaces').checked = data.notify_races;
                    if (data.notify_news !== undefined) document.getElementById('notifyNews').checked = data.notify_news;
                }
            })
            .catch(() => {
                window.location.href = '/index.html?error=login';
            });

        // Guardar cambios de cuenta
        document.getElementById('btnSaveAccount').addEventListener('click', async () => {
            const username = document.getElementById('configUsername').value.trim();
            const email = document.getElementById('configEmail').value.trim();
            const escuderia = document.getElementById('configEscuderia').value.trim();
            const language = document.getElementById('languageSelect').value;
            const notifyEmail = document.getElementById('notifyEmail').checked;
            const notifyRaces = document.getElementById('notifyRaces').checked;
            const notifyNews = document.getElementById('notifyNews').checked;
            const messageEl = document.getElementById('saveMessage');

            console.log('[CONFIG] Guardando cuenta con idioma:', language);

            if (!username || !email) {
                messageEl.textContent = 'âŒ El nombre de usuario y email son obligatorios';
                messageEl.className = 'form-message error';
                return;
            }

            try {
                const res = await fetch('/api/update-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, escuderia, language, notifyEmail, notifyRaces, notifyNews })
                });

                const data = await res.json();
                console.log('[CONFIG] Respuesta del servidor:', data);

                if (res.ok) {
                    messageEl.textContent = 'âœ… Datos guardados correctamente';
                    messageEl.className = 'form-message success';
                    // Actualizar navbar
                    document.getElementById('userName').innerText = username;
                    document.getElementById('userTeam').innerText = escuderia || 'EscuderÃ­a';
                    document.getElementById('userNameMobile').innerText = username;
                    document.getElementById('userTeamMobile').innerText = escuderia || 'EscuderÃ­a';
                    // Actualizar idioma visualmente
                    document.documentElement.lang = language;
                    // Recargar traducciones si existe i18n
                    if (window.i18n) {
                        console.log('[CONFIG] Recargando traducciones para:', language);
                        await window.i18n.loadTranslations(language);
                        window.i18n.applyTranslations();
                    }
                } else {
                    messageEl.textContent = 'âŒ ' + (data.error || 'Error al guardar');
                    messageEl.className = 'form-message error';
                }
            } catch (err) {
                console.error('[CONFIG] Error:', err);
                messageEl.textContent = 'âŒ Error de conexiÃ³n';
                messageEl.className = 'form-message error';
            }
        });

        // Solicitar cambio de contraseÃ±a
        document.getElementById('btnRequestPassword').addEventListener('click', async () => {
            const messageEl = document.getElementById('passwordMessage');

            try {
                const res = await fetch('/api/request-password-change', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await res.json();

                if (res.ok) {
                    messageEl.textContent = 'âœ… Se ha enviado un enlace a tu correo electrÃ³nico';
                    messageEl.className = 'form-message success';
                } else {
                    messageEl.textContent = 'âŒ ' + (data.error || 'Error al solicitar');
                    messageEl.className = 'form-message error';
                }
            } catch (err) {
                messageEl.textContent = 'âŒ Error de conexiÃ³n';
                messageEl.className = 'form-message error';
            }
        });

        // Modal de eliminar cuenta
        const deleteModal = document.getElementById('deleteModal');
        const deleteInput = document.getElementById('deleteConfirmInput');
        const btnConfirmDelete = document.getElementById('btnConfirmDelete');

        function showDeleteConfirm() {
            deleteModal.classList.add('active');
            deleteInput.value = '';
            btnConfirmDelete.disabled = true;
        }

        function hideDeleteModal() {
            deleteModal.classList.remove('active');
        }

        deleteInput.addEventListener('input', (e) => {
            btnConfirmDelete.disabled = e.target.value !== 'ELIMINAR';
        });

        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                hideDeleteModal();
            }
        });

        function deleteAccount() {
            if (deleteInput.value !== 'ELIMINAR') return;
            alert('FunciÃ³n de eliminaciÃ³n de cuenta - pendiente de implementar en el servidor');
        }
    </script>
<script src="preload-fondos.js"></script>
</body>
</html>
