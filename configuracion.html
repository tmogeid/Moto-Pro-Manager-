<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="config.title">Settings | Moto Pro Manager</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="cookie-consent.js"></script>
    <script src="background-changer.js"></script>
    <script src="js/i18n.js"></script>
</head>
<body class="paddock-page">
    <!-- NAVBAR -->
    <nav class="nav-mobile">
        <div class="nav-mobile-bar">
            <div class="nav-logo">
                <img src="favicon.png" alt="Logo" class="nav-logo-img-mobile">
                <span class="nav-page-title" data-i18n="config.title">ConfiguraciÃ³n</span>
            </div>
            <button class="hamburger" id="hamburgerBtn" aria-label="MenÃº">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
        </div>
    </nav>

    <!-- OVERLAY -->
    <div class="nav-overlay" id="navOverlay"></div>

    <!-- MENÃš DESPLEGABLE -->
    <div class="nav-mobile-menu" id="navMobileMenu">
        <a href="/paddock" class="nav-mobile-link">ğŸ <span data-i18n="paddock.title">Paddock</span></a>
        <div class="nav-mobile-dropdown">
            <button class="nav-mobile-dropdown-toggle" id="garajeToggle">
                ğŸï¸ Garaje
                <span class="dropdown-arrow">â–¼</span>
            </button>
            <div class="nav-mobile-dropdown-menu" id="garajeDropdown">
                <a href="/piloto" class="nav-mobile-link nav-mobile-sub">ğŸ‘¤ Pilotos</a>
                <a href="/moto" class="nav-mobile-link nav-mobile-sub">ğŸï¸ Moto</a>
            </div>
        </div>
        <a href="/configuracion" class="nav-mobile-link">âš™ï¸ <span data-i18n="config.title">ConfiguraciÃ³n</span></a>
        <a href="/logout" class="nav-mobile-link nav-mobile-logout">ğŸšª <span data-i18n="paddock.logout">Cerrar SesiÃ³n</span></a>
        <div class="nav-mobile-user">
            <div class="nav-user-avatar" id="userAvatarMobile">U</div>
            <div>
                <div class="nav-user-name" id="userNameMobile">...</div>
                <div class="nav-user-team" id="userTeamMobile">EscuderÃ­a</div>
                <div class="nav-user-money" id="userBudgetMobile">0 â‚¬</div>
            </div>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="paddock-main">
        <!-- Mi Cuenta -->
        <section class="config-section">
            <h2 class="config-title">ğŸ‘¤ <span data-i18n="config.myAccount">Mi Cuenta</span></h2>
            <div class="config-form">
                <div class="form-group">
                    <label data-i18n="config.username">Nombre de usuario</label>
                    <input type="text" id="configUsername" placeholder="Usuario">
                </div>
                <div class="form-group">
                    <label data-i18n="config.email">Email</label>
                    <input type="email" id="configEmail" placeholder="usuario@email.com">
                </div>
                <div class="form-group">
                    <label data-i18n="config.teamName">Nombre de la escuderÃ­a</label>
                    <input type="text" id="configEscuderia" placeholder="EscuderÃ­a Pro">
                </div>
                <div class="form-group">
                    <label data-i18n="config.language">Idioma</label>
                    <select id="languageSelect" class="config-select">
                        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                        <option value="eslat">ğŸŒ EspaÃ±ol Latino</option>
                        <option value="en">ğŸ‡¬ğŸ‡§ English</option>
                        <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
                        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                        <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
                        <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                        <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                        <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                    </select>
                </div>

                <!-- Notificaciones -->
                <div class="form-group">
                    <label data-i18n="config.notifications">Notificaciones</label>
                    <div class="toggle-list-inline">
                        <label class="toggle-item">
                            <span data-i18n="config.emailNotifications">Email</span>
                            <input type="checkbox" id="notifyEmail" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-item">
                            <span data-i18n="config.raceNotifications">Carreras</span>
                            <input type="checkbox" id="notifyRaces" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-item">
                            <span data-i18n="config.newsNotifications">Noticias</span>
                            <input type="checkbox" id="notifyNews">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <button class="btn-save" id="btnSaveAccount" data-i18n="config.saveChanges">Guardar Cambios</button>
                <div id="saveMessage" class="form-message"></div>
            </div>
        </section>

        <!-- Cambiar ContraseÃ±a -->
        <section class="config-section">
            <h2 class="config-title">ğŸ” <span data-i18n="config.changePassword">Cambiar ContraseÃ±a</span></h2>
            <p class="config-description" data-i18n="config.passwordDesc">Si deseas cambiar tu contraseÃ±a, te enviaremos un enlace a tu correo electrÃ³nico.</p>
            <button class="btn-save btn-secondary" id="btnRequestPassword" data-i18n="config.requestPassword">Solicitar Cambio de ContraseÃ±a</button>
            <div id="passwordMessage" class="form-message"></div>
        </section>

        <!-- Zona Peligrosa - Eliminar Cuenta -->
        <section class="config-section config-danger">
            <h2 class="config-title config-title-danger">âš ï¸ <span data-i18n="config.dangerZone">Zona Peligrosa</span></h2>
            <p class="config-danger-text" data-i18n="config.dangerText">Estas acciones son irreversibles. AsegÃºrate de saber lo que estÃ¡s haciendo.</p>
            <button class="btn-danger" onclick="showDeleteConfirm()">ğŸ—‘ï¸ <span data-i18n="config.deleteAccount">Eliminar Mi Cuenta</span></button>
        </section>

        <!-- Panel de Administrador (solo visible para admins) -->
        <section class="config-section config-admin" id="adminSection" style="display: none;">
            <h2 class="config-title config-title-admin">ğŸ‘‘ Panel de Administrador</h2>
            <p class="config-description">Herramientas exclusivas para la gestiÃ³n del juego.</p>
            
            <div class="admin-tools">
                <div class="admin-tool">
                    <h3>ğŸ–¼ï¸ Avatares de Pilotos</h3>
                    <p>Genera avatares SVG para todos los pilotos del juego. Los avatares se guardan en la base de datos y se basan en la edad y peso de cada piloto.</p>
                    <div id="avatarStatusInfo" class="admin-status-info"></div>
                    <button class="btn-admin" id="btnGenerateAvatars" onclick="checkAndGenerateAvatars()">
                        ğŸ”„ Actualizar Avatares de Pilotos
                    </button>
                    <div id="avatarStatus" class="admin-status"></div>
                </div>
                
                <div class="admin-tool">
                    <h3>ğŸ”§ Sistema</h3>
                    <p>Herramientas de mantenimiento del sistema.</p>
                    <button class="btn-admin btn-secondary" id="btnEnsureAvatarColumn" onclick="ensureAvatarColumn()">
                        ğŸ“‹ Verificar Columna Avatar
                    </button>
                    <div id="systemStatus" class="admin-status"></div>
                </div>
            </div>
        </section>
        
        <!-- Modal de Progreso -->
        <div class="modal-overlay" id="progressModal">
            <div class="modal-box modal-progress">
                <button class="modal-close-btn" id="progressCloseBtn" onclick="closeProgressModal()" style="display: none;">âœ•</button>
                <div class="modal-icon" id="progressIcon">â³</div>
                <h3 class="modal-title" id="progressTitle">Generando Avatares</h3>
                <p class="modal-text" id="progressText">Procesando pilotos...</p>
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progressPercent">0%</div>
                </div>
                
                <div class="progress-details" id="progressDetails"></div>
            </div>
        </section>
    </main>

    <!-- Modal de ConfirmaciÃ³n para Eliminar Cuenta -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <div class="modal-icon">âš ï¸</div>
            <h3 class="modal-title">Â¿EstÃ¡s seguro?</h3>
            <p class="modal-text">Esta acciÃ³n eliminarÃ¡ permanentemente tu cuenta, escuderÃ­a y todos los datos asociados. No podrÃ¡s recuperar esta informaciÃ³n.</p>
            <p class="modal-subtext">Escribe <strong>ELIMINAR</strong> para confirmar:</p>
            <input type="text" id="deleteConfirmInput" class="modal-input" placeholder="Escribe ELIMINAR">
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="hideDeleteModal()">Cancelar</button>
                <button class="btn-confirm-delete" id="btnConfirmDelete" onclick="deleteAccount()" disabled>Eliminar Cuenta</button>
            </div>
        </div>
    </div>

    <script src="nav-menu.js"></script>
    <script>
        // Variable para verificar si es admin
        let isAdmin = false;
        
        // Cargar datos del usuario y verificar admin
        fetch('/api/user-data')
            .then(res => {
                if (!res.ok) {
                    window.location.href = '/index.html?error=login';
                    return null;
                }
                return res.json();
            })
            .then(data => {
                if (data) {
                    // Navbar mÃ³vil
                    document.getElementById('userNameMobile').innerText = data.username;
                    document.getElementById('userTeamMobile').innerText = data.escuderia || 'EscuderÃ­a';
                    document.getElementById('userBudgetMobile').innerText = new Intl.NumberFormat('de-DE').format(data.budget) + " â‚¬";
                    document.getElementById('userAvatarMobile').innerText = data.username.charAt(0).toUpperCase();
                    // Formulario
                    document.getElementById('configUsername').value = data.username;
                    document.getElementById('configEmail').value = data.email || '';
                    document.getElementById('configEscuderia').value = data.escuderia || '';
                    // Idioma - seleccionar el valor correcto
                    document.getElementById('languageSelect').value = data.language || 'es';
                    // Notificaciones
                    if (data.notify_email !== undefined) document.getElementById('notifyEmail').checked = data.notify_email;
                    if (data.notify_races !== undefined) document.getElementById('notifyRaces').checked = data.notify_races;
                    if (data.notify_news !== undefined) document.getElementById('notifyNews').checked = data.notify_news;
                    
                    // Verificar si es admin y mostrar panel
                    if (data.isAdmin) {
                        isAdmin = true;
                        document.getElementById('adminSection').style.display = 'block';
                        console.log('[CONFIG] Usuario es admin, panel mostrado');
                        // Cargar estado de avatares
                        loadAvatarsStatus();
                    }
                }
            })
            .catch(() => {
                window.location.href = '/index.html?error=login';
            });

        // Guardar cambios de cuenta
        document.getElementById('btnSaveAccount').addEventListener('click', async () => {
            const username = document.getElementById('configUsername').value.trim();
            const email = document.getElementById('configEmail').value.trim();
            const escuderia = document.getElementById('configEscuderia').value.trim();
            const language = document.getElementById('languageSelect').value;
            const notifyEmail = document.getElementById('notifyEmail').checked;
            const notifyRaces = document.getElementById('notifyRaces').checked;
            const notifyNews = document.getElementById('notifyNews').checked;
            const messageEl = document.getElementById('saveMessage');

            console.log('[CONFIG] Iniciando guardado de cuenta con idioma:', language);

            if (!username || !email) {
                messageEl.textContent = 'âŒ El nombre de usuario y email son obligatorios';
                messageEl.className = 'form-message error';
                return;
            }

            let res;
            let data;

            // FASE 1: Guardar en servidor
            try {
                console.log('[CONFIG] Enviando peticiÃ³n al servidor...');
                res = await fetch('/api/update-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, escuderia, language, notifyEmail, notifyRaces, notifyNews })
                });
                console.log('[CONFIG] Respuesta recibida, status:', res.status);
            } catch (netErr) {
                console.error('[CONFIG] Error de red:', netErr);
                messageEl.textContent = 'âŒ Error de conexiÃ³n con el servidor';
                messageEl.className = 'form-message error';
                return;
            }

            // FASE 2: Parsear respuesta JSON
            try {
                data = await res.json();
                console.log('[CONFIG] Datos del servidor:', data);
            } catch (parseErr) {
                console.error('[CONFIG] Error parseando JSON:', parseErr);
                messageEl.textContent = 'âŒ Error procesando respuesta del servidor';
                messageEl.className = 'form-message error';
                return;
            }

            // FASE 3: Procesar resultado
            if (res.ok && data.success) {
                messageEl.textContent = 'âœ… Datos guardados correctamente';
                messageEl.className = 'form-message success';
                
                // Actualizar navbar
                try {
                    document.getElementById('userNameMobile').innerText = username;
                    document.getElementById('userTeamMobile').innerText = escuderia || 'EscuderÃ­a';
                    document.documentElement.lang = language;
                } catch (navErr) {
                    console.warn('[CONFIG] Error actualizando navbar:', navErr);
                }
                
                // Recargar traducciones en segundo plano (no bloquea el Ã©xito)
                if (window.i18n && typeof window.i18n.loadTranslations === 'function') {
                    console.log('[CONFIG] Recargando traducciones para:', language);
                    window.i18n.loadTranslations(language).then(() => {
                        if (typeof window.i18n.applyTranslations === 'function') {
                            window.i18n.applyTranslations();
                        }
                        console.log('[CONFIG] Traducciones aplicadas');
                    }).catch(err => {
                        console.warn('[CONFIG] Traducciones no recargadas (no crÃ­tico):', err.message);
                    });
                }
            } else {
                // El servidor respondiÃ³ con error
                messageEl.textContent = 'âŒ ' + (data.error || 'Error al guardar');
                messageEl.className = 'form-message error';
            }
        });

        // Solicitar cambio de contraseÃ±a
        document.getElementById('btnRequestPassword').addEventListener('click', async () => {
            const messageEl = document.getElementById('passwordMessage');

            try {
                const res = await fetch('/api/request-password-change', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await res.json();

                if (res.ok) {
                    messageEl.textContent = 'âœ… Se ha enviado un enlace a tu correo electrÃ³nico';
                    messageEl.className = 'form-message success';
                } else {
                    messageEl.textContent = 'âŒ ' + (data.error || 'Error al solicitar');
                    messageEl.className = 'form-message error';
                }
            } catch (err) {
                messageEl.textContent = 'âŒ Error de conexiÃ³n';
                messageEl.className = 'form-message error';
            }
        });

        // Modal de eliminar cuenta
        const deleteModal = document.getElementById('deleteModal');
        const deleteInput = document.getElementById('deleteConfirmInput');
        const btnConfirmDelete = document.getElementById('btnConfirmDelete');

        function showDeleteConfirm() {
            deleteModal.classList.add('active');
            deleteInput.value = '';
            btnConfirmDelete.disabled = true;
        }

        function hideDeleteModal() {
            deleteModal.classList.remove('active');
        }

        deleteInput.addEventListener('input', (e) => {
            btnConfirmDelete.disabled = e.target.value !== 'ELIMINAR';
        });

        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                hideDeleteModal();
            }
        });

        function deleteAccount() {
            if (deleteInput.value !== 'ELIMINAR') return;
            alert('FunciÃ³n de eliminaciÃ³n de cuenta - pendiente de implementar en el servidor');
        }
        
        // ========================================
        // FUNCIONES DE ADMINISTRADOR
        // ========================================
        
        // Cargar estado de avatares al iniciar
        async function loadAvatarsStatus() {
            if (!isAdmin) return;
            
            try {
                const res = await fetch('/api/admin/avatars-status');
                const data = await res.json();
                
                const statusInfo = document.getElementById('avatarStatusInfo');
                if (data.total === 0) {
                    statusInfo.innerHTML = '<span style="color: #888;">â„¹ï¸ No hay pilotos en la base de datos</span>';
                } else if (data.todosCompletos) {
                    statusInfo.innerHTML = `<span style="color: #00c853;">âœ… Todos los avatares estÃ¡n generados (${data.total}/${data.total})</span>`;
                } else {
                    statusInfo.innerHTML = `<span style="color: #ff9800;">âš ï¸ Avatares pendientes: ${data.sinAvatar} de ${data.total}</span>`;
                }
            } catch (err) {
                console.error('Error cargando estado de avatares:', err);
            }
        }
        
        // Verificar y generar avatares
        async function checkAndGenerateAvatars() {
            const statusEl = document.getElementById('avatarStatus');
            const btn = document.getElementById('btnGenerateAvatars');
            
            btn.disabled = true;
            
            try {
                // Verificar estado actual
                const statusRes = await fetch('/api/admin/avatars-status');
                const statusData = await statusRes.json();
                
                if (statusData.todosCompletos) {
                    // Ya estÃ¡n todos, mostrar aviso
                    showProgressModal({
                        type: 'warning',
                        title: 'Avatares ya generados',
                        text: `Todos los ${statusData.total} pilotos ya tienen avatar generado. No es necesario actualizar.`,
                        showClose: true
                    });
                    btn.disabled = false;
                    return;
                }
                
                if (statusData.total === 0) {
                    showProgressModal({
                        type: 'info',
                        title: 'Sin pilotos',
                        text: 'No hay pilotos en la base de datos para generar avatares.',
                        showClose: true
                    });
                    btn.disabled = false;
                    return;
                }
                
                // Mostrar modal de progreso
                showProgressModal({
                    type: 'loading',
                    title: 'Generando Avatares',
                    text: `Preparando ${statusData.sinAvatar} avatares...`,
                    total: statusData.sinAvatar,
                    current: 0
                });
                
                // Simular progreso visual mientras se procesa
                simulateProgress(statusData.sinAvatar);
                
                // Llamar a la API
                const res = await fetch('/api/admin/generate-avatars', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();
                
                // Actualizar al completar
                if (res.ok && data.success) {
                    completeProgress({
                        updated: data.updated,
                        total: data.total,
                        errors: data.errors
                    });
                    
                    // Recargar estado
                    await loadAvatarsStatus();
                } else {
                    showProgressModal({
                        type: 'error',
                        title: 'Error',
                        text: data.error || 'Error desconocido',
                        showClose: true
                    });
                }
                
            } catch (err) {
                showProgressModal({
                    type: 'error',
                    title: 'Error de ConexiÃ³n',
                    text: err.message,
                    showClose: true
                });
            } finally {
                btn.disabled = false;
            }
        }
        
        // Simular progreso visual
        let progressInterval = null;
        function simulateProgress(total) {
            let current = 0;
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            const progressDetails = document.getElementById('progressDetails');
            
            clearInterval(progressInterval);
            
            progressInterval = setInterval(() => {
                if (current < total - 1) {
                    current++;
                    const percent = Math.round((current / total) * 90); // Max 90% hasta que termine
                    progressFill.style.width = percent + '%';
                    progressPercent.textContent = percent + '%';
                    progressDetails.innerHTML = `<span style="color: #ffc107;">Procesando: ${current} / ${total}</span>`;
                }
            }, 100);
        }
        
        // Completar progreso
        function completeProgress(data) {
            clearInterval(progressInterval);
            
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            const progressDetails = document.getElementById('progressDetails');
            const progressTitle = document.getElementById('progressTitle');
            const progressText = document.getElementById('progressText');
            const progressIcon = document.getElementById('progressIcon');
            const progressCloseBtn = document.getElementById('progressCloseBtn');
            const progressContainer = document.getElementById('progressContainer');
            
            // Animar al 100%
            progressFill.style.width = '100%';
            progressPercent.textContent = '100%';
            progressFill.style.background = 'linear-gradient(90deg, #00c853, #69f0ae)';
            
            // Cambiar a mensaje de Ã©xito
            progressIcon.textContent = 'âœ…';
            progressTitle.textContent = 'Â¡Proceso Completado!';
            progressText.textContent = `Se generaron ${data.updated} avatares correctamente.`;
            
            if (data.errors && data.errors.length > 0) {
                progressDetails.innerHTML = `
                    <span style="color: #ff9800;">âš ï¸ ${data.errors.length} errores:</span>
                    <div style="font-size: 11px; color: #888; margin-top: 8px; max-height: 60px; overflow-y: auto;">
                        ${data.errors.map(e => `<div>â€¢ ${e}</div>`).join('')}
                    </div>
                `;
            } else {
                progressDetails.innerHTML = '<span style="color: #00c853;">âœ¨ Todos los avatares generados sin errores</span>';
            }
            
            // Mostrar botÃ³n de cerrar
            progressCloseBtn.style.display = 'block';
        }
        
        // Mostrar modal de progreso
        function showProgressModal(options) {
            const modal = document.getElementById('progressModal');
            const progressIcon = document.getElementById('progressIcon');
            const progressTitle = document.getElementById('progressTitle');
            const progressText = document.getElementById('progressText');
            const progressContainer = document.getElementById('progressContainer');
            const progressDetails = document.getElementById('progressDetails');
            const progressCloseBtn = document.getElementById('progressCloseBtn');
            const progressFill = document.getElementById('progressFill');
            
            // Reset
            progressFill.style.width = '0%';
            progressFill.style.background = 'linear-gradient(90deg, #ffc107, #ff9800)';
            document.getElementById('progressPercent').textContent = '0%';
            progressCloseBtn.style.display = options.showClose ? 'block' : 'none';
            progressDetails.innerHTML = '';
            
            switch(options.type) {
                case 'warning':
                    progressIcon.textContent = 'âš ï¸';
                    progressContainer.style.display = 'none';
                    break;
                case 'error':
                    progressIcon.textContent = 'âŒ';
                    progressContainer.style.display = 'none';
                    break;
                case 'info':
                    progressIcon.textContent = 'â„¹ï¸';
                    progressContainer.style.display = 'none';
                    break;
                case 'loading':
                    progressIcon.textContent = 'â³';
                    progressContainer.style.display = 'block';
                    break;
                default:
                    progressContainer.style.display = 'none';
            }
            
            progressTitle.textContent = options.title || 'Procesando';
            progressText.textContent = options.text || '';
            
            modal.classList.add('active');
        }
        
        // Cerrar modal de progreso
        function closeProgressModal() {
            clearInterval(progressInterval);
            document.getElementById('progressModal').classList.remove('active');
        }
        
        // Cerrar al hacer clic fuera
        document.getElementById('progressModal').addEventListener('click', (e) => {
            if (e.target.id === 'progressModal') {
                closeProgressModal();
            }
        });
        
        async function ensureAvatarColumn() {
            const statusEl = document.getElementById('systemStatus');
            const btn = document.getElementById('btnEnsureAvatarColumn');
            
            statusEl.innerHTML = '<span class="loading">â³ Verificando...</span>';
            btn.disabled = true;
            
            try {
                const res = await fetch('/api/admin/ensure-avatar-column', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    statusEl.innerHTML = `<span class="success">âœ… ${data.message}</span>`;
                } else {
                    statusEl.innerHTML = `<span class="error">âŒ ${data.error || 'Error desconocido'}</span>`;
                }
            } catch (err) {
                statusEl.innerHTML = `<span class="error">âŒ Error de conexiÃ³n: ${err.message}</span>`;
            } finally {
                btn.disabled = false;
            }
        }
    </script>
    <style>
        /* Estilos del panel de administrador */
        .config-admin {
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid rgba(255, 193, 7, 0.3);
        }
        
        .config-title-admin {
            color: #ffc107;
        }
        
        .admin-tools {
            display: grid;
            gap: 20px;
            margin-top: 16px;
        }
        
        .admin-tool {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        .admin-tool h3 {
            margin: 0 0 8px 0;
            color: #fff;
            font-size: 16px;
        }
        
        .admin-tool p {
            margin: 0 0 16px 0;
            color: #aaa;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .btn-admin {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }
        
        .btn-admin:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-admin.btn-secondary {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        .btn-admin.btn-secondary:hover {
            background: rgba(255, 193, 7, 0.3);
        }
        
        .admin-status {
            margin-top: 12px;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .admin-status .loading {
            color: #ffc107;
        }
        
        .admin-status .success {
            color: #00c853;
        }
        
        .admin-status .error {
            color: #f44336;
        }
        
        /* Modal de progreso */
        .modal-progress {
            max-width: 400px;
            text-align: center;
        }
        
        .modal-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #888;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .modal-close-btn:hover {
            background: rgba(255, 87, 34, 0.3);
            color: #ff5722;
        }
        
        .modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .modal-title {
            font-size: 20px;
            margin: 0 0 8px 0;
            color: #fff;
        }
        
        .modal-text {
            font-size: 14px;
            color: #aaa;
            margin: 0 0 20px 0;
        }
        
        .progress-container {
            margin-bottom: 16px;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffc107, #ff9800);
            border-radius: 6px;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 14px;
            color: #fff;
            font-weight: bold;
        }
        
        .progress-details {
            font-size: 13px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-top: 12px;
        }
        
        .admin-status-info {
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 13px;
        }
    </style>
<script src="preload-fondos.js"></script>
</body>
</html>
