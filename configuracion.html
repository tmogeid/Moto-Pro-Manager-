<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="config.title">Settings | Moto Pro Manager</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="cookie-consent.js"></script>
    <script src="background-changer.js"></script>
    <script src="js/i18n.js"></script>
</head>
<body class="paddock-page">
    <!-- NAVBAR -->
    <nav class="nav-mobile">
        <div class="nav-mobile-bar">
            <div class="nav-logo">
                <img src="favicon.png" alt="Logo" class="nav-logo-img-mobile">
                <span class="nav-page-title" data-i18n="config.title">Configuraci√≥n</span>
            </div>
            <button class="hamburger" id="hamburgerBtn" aria-label="Men√∫">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
        </div>
    </nav>

    <!-- OVERLAY -->
    <div class="nav-overlay" id="navOverlay"></div>

    <!-- MEN√ö DESPLEGABLE -->
    <div class="nav-mobile-menu" id="navMobileMenu">
        <a href="/paddock" class="nav-mobile-link">üèÅ <span data-i18n="paddock.title">Paddock</span></a>
        <div class="nav-mobile-dropdown">
            <button class="nav-mobile-dropdown-toggle" id="garajeToggle">
                üèçÔ∏è Garaje
                <span class="dropdown-arrow">‚ñº</span>
            </button>
            <div class="nav-mobile-dropdown-menu" id="garajeDropdown">
                <a href="/piloto" class="nav-mobile-link nav-mobile-sub">üë§ Pilotos</a>
                <a href="/moto" class="nav-mobile-link nav-mobile-sub">üèçÔ∏è Moto</a>
            </div>
        </div>
        <a href="/configuracion" class="nav-mobile-link">‚öôÔ∏è <span data-i18n="config.title">Configuraci√≥n</span></a>
        <a href="/logout" class="nav-mobile-link nav-mobile-logout">üö™ <span data-i18n="paddock.logout">Cerrar Sesi√≥n</span></a>
        <div class="nav-mobile-user">
            <div class="nav-user-avatar" id="userAvatarMobile">U</div>
            <div>
                <div class="nav-user-name" id="userNameMobile">...</div>
                <div class="nav-user-team" id="userTeamMobile">Escuder√≠a</div>
                <div class="nav-user-money" id="userBudgetMobile">0 ‚Ç¨</div>
            </div>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="paddock-main">
        <!-- Mi Cuenta -->
        <section class="config-section">
            <h2 class="config-title">üë§ <span data-i18n="config.myAccount">Mi Cuenta</span></h2>
            <div class="config-form">
                <div class="form-group">
                    <label data-i18n="config.username">Nombre de usuario</label>
                    <input type="text" id="configUsername" placeholder="Usuario">
                </div>
                <div class="form-group">
                    <label data-i18n="config.email">Email</label>
                    <input type="email" id="configEmail" placeholder="usuario@email.com">
                </div>
                <div class="form-group">
                    <label data-i18n="config.teamName">Nombre de la escuder√≠a</label>
                    <input type="text" id="configEscuderia" placeholder="Escuder√≠a Pro">
                </div>
                <div class="form-group">
                    <label data-i18n="config.language">Idioma</label>
                    <select id="languageSelect" class="config-select">
                        <option value="es">üá™üá∏ Espa√±ol</option>
                        <option value="eslat">üåé Espa√±ol Latino</option>
                        <option value="en">üá¨üáß English</option>
                        <option value="pt">üáµüáπ Portugu√™s</option>
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                        <option value="de">üá©üá™ Deutsch</option>
                        <option value="it">üáÆüáπ Italiano</option>
                        <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                        <option value="zh">üá®üá≥ ‰∏≠Êñá</option>
                        <option value="ja">üáØüáµ Êó•Êú¨Ë™û</option>
                    </select>
                </div>

                <!-- Notificaciones -->
                <div class="form-group">
                    <label data-i18n="config.notifications">Notificaciones</label>
                    <div class="toggle-list-inline">
                        <label class="toggle-item">
                            <span data-i18n="config.emailNotifications">Email</span>
                            <input type="checkbox" id="notifyEmail" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-item">
                            <span data-i18n="config.raceNotifications">Carreras</span>
                            <input type="checkbox" id="notifyRaces" checked>
                            <span class="toggle-slider"></span>
                        </label>
                        <label class="toggle-item">
                            <span data-i18n="config.newsNotifications">Noticias</span>
                            <input type="checkbox" id="notifyNews">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <button class="btn-save" id="btnSaveAccount" data-i18n="config.saveChanges">Guardar Cambios</button>
                <div id="saveMessage" class="form-message"></div>
            </div>
        </section>

        <!-- Cambiar Contrase√±a -->
        <section class="config-section">
            <h2 class="config-title">üîê <span data-i18n="config.changePassword">Cambiar Contrase√±a</span></h2>
            <p class="config-description" data-i18n="config.passwordDesc">Si deseas cambiar tu contrase√±a, te enviaremos un enlace a tu correo electr√≥nico.</p>
            <button class="btn-save btn-secondary" id="btnRequestPassword" data-i18n="config.requestPassword">Solicitar Cambio de Contrase√±a</button>
            <div id="passwordMessage" class="form-message"></div>
        </section>

        <!-- Zona Peligrosa - Eliminar Cuenta -->
        <section class="config-section config-danger">
            <h2 class="config-title config-title-danger">‚ö†Ô∏è <span data-i18n="config.dangerZone">Zona Peligrosa</span></h2>
            <p class="config-danger-text" data-i18n="config.dangerText">Estas acciones son irreversibles. Aseg√∫rate de saber lo que est√°s haciendo.</p>
            <button class="btn-danger" onclick="showDeleteConfirm()">üóëÔ∏è <span data-i18n="config.deleteAccount">Eliminar Mi Cuenta</span></button>
        </section>

        <!-- Panel de Administrador (solo visible para admins) -->
        <section class="config-section config-admin" id="adminSection" style="display: none;">
            <h2 class="config-title config-title-admin">üëë Panel de Administrador</h2>
            <p class="config-description">Herramientas exclusivas para la gesti√≥n del juego.</p>
            
            <div class="admin-tools">
                <div class="admin-tool">
                    <h3>üñºÔ∏è Avatares de Pilotos</h3>
                    <p>Genera avatares de retrato estilo ilustraci√≥n con SVG. Incluyen diferentes tipos de cara, estilos de pelo, barba, gafas y m√°s seg√∫n edad y peso.</p>
                    <div id="avatarStatusInfo" class="admin-status-info"></div>
                    <button class="btn-admin" id="btnGenerateAvatars" onclick="checkAndGenerateAvatars()">
                        üé® Generar Avatares
                    </button>
                    <div id="avatarStatus" class="admin-status"></div>
                </div>
                
                <div class="admin-tool">
                    <h3>üîß Sistema</h3>
                    <p>Herramientas de mantenimiento del sistema.</p>
                    <button class="btn-admin btn-secondary" id="btnEnsureAvatarColumn" onclick="ensureAvatarColumn()">
                        üìã Verificar Columna Avatar
                    </button>
                    <div id="systemStatus" class="admin-status"></div>
                </div>
            </div>
        </section>
        
        <!-- Modal de Progreso -->
        <div class="modal-overlay" id="progressModal">
            <div class="modal-box modal-progress">
                <button class="modal-close-btn" id="progressCloseBtn" onclick="closeProgressModal()" style="display: none;">‚úï</button>
                <div class="modal-icon" id="progressIcon">‚è≥</div>
                <h3 class="modal-title" id="progressTitle">Generando Avatares</h3>
                <p class="modal-text" id="progressText">Procesando pilotos...</p>
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text" id="progressPercent">0%</div>
                </div>
                
                <div class="progress-details" id="progressDetails"></div>
                <div id="avatarPreview" style="margin-top: 16px;"></div>
            </div>
        </section>
    </main>

    <!-- Modal de Confirmaci√≥n para Eliminar Cuenta -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-box">
            <div class="modal-icon">‚ö†Ô∏è</div>
            <h3 class="modal-title">¬øEst√°s seguro?</h3>
            <p class="modal-text">Esta acci√≥n eliminar√° permanentemente tu cuenta, escuder√≠a y todos los datos asociados. No podr√°s recuperar esta informaci√≥n.</p>
            <p class="modal-subtext">Escribe <strong>ELIMINAR</strong> para confirmar:</p>
            <input type="text" id="deleteConfirmInput" class="modal-input" placeholder="Escribe ELIMINAR">
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="hideDeleteModal()">Cancelar</button>
                <button class="btn-confirm-delete" id="btnConfirmDelete" onclick="deleteAccount()" disabled>Eliminar Cuenta</button>
            </div>
        </div>
    </div>

    <script src="nav-menu.js"></script>
    <script>
        // Variable para verificar si es admin
        let isAdmin = false;
        
        // Cargar datos del usuario y verificar admin
        fetch('/api/user-data')
            .then(res => {
                if (!res.ok) {
                    window.location.href = '/index.html?error=login';
                    return null;
                }
                return res.json();
            })
            .then(data => {
                if (data) {
                    // Navbar m√≥vil
                    document.getElementById('userNameMobile').innerText = data.username;
                    document.getElementById('userTeamMobile').innerText = data.escuderia || 'Escuder√≠a';
                    document.getElementById('userBudgetMobile').innerText = new Intl.NumberFormat('de-DE').format(data.budget) + " ‚Ç¨";
                    document.getElementById('userAvatarMobile').innerText = data.username.charAt(0).toUpperCase();
                    // Formulario
                    document.getElementById('configUsername').value = data.username;
                    document.getElementById('configEmail').value = data.email || '';
                    document.getElementById('configEscuderia').value = data.escuderia || '';
                    // Idioma - seleccionar el valor correcto
                    document.getElementById('languageSelect').value = data.language || 'es';
                    // Notificaciones
                    if (data.notify_email !== undefined) document.getElementById('notifyEmail').checked = data.notify_email;
                    if (data.notify_races !== undefined) document.getElementById('notifyRaces').checked = data.notify_races;
                    if (data.notify_news !== undefined) document.getElementById('notifyNews').checked = data.notify_news;
                    
                    // Verificar si es admin y mostrar panel
                    if (data.isAdmin) {
                        isAdmin = true;
                        document.getElementById('adminSection').style.display = 'block';
                        console.log('[CONFIG] Usuario es admin, panel mostrado');
                        // Cargar estado de avatares
                        loadAvatarsStatus();
                    }
                }
            })
            .catch(() => {
                window.location.href = '/index.html?error=login';
            });

        // Guardar cambios de cuenta
        document.getElementById('btnSaveAccount').addEventListener('click', async () => {
            const username = document.getElementById('configUsername').value.trim();
            const email = document.getElementById('configEmail').value.trim();
            const escuderia = document.getElementById('configEscuderia').value.trim();
            const language = document.getElementById('languageSelect').value;
            const notifyEmail = document.getElementById('notifyEmail').checked;
            const notifyRaces = document.getElementById('notifyRaces').checked;
            const notifyNews = document.getElementById('notifyNews').checked;
            const messageEl = document.getElementById('saveMessage');

            console.log('[CONFIG] Iniciando guardado de cuenta con idioma:', language);

            if (!username || !email) {
                messageEl.textContent = '‚ùå El nombre de usuario y email son obligatorios';
                messageEl.className = 'form-message error';
                return;
            }

            let res;
            let data;

            // FASE 1: Guardar en servidor
            try {
                console.log('[CONFIG] Enviando petici√≥n al servidor...');
                res = await fetch('/api/update-account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, escuderia, language, notifyEmail, notifyRaces, notifyNews })
                });
                console.log('[CONFIG] Respuesta recibida, status:', res.status);
            } catch (netErr) {
                console.error('[CONFIG] Error de red:', netErr);
                messageEl.textContent = '‚ùå Error de conexi√≥n con el servidor';
                messageEl.className = 'form-message error';
                return;
            }

            // FASE 2: Parsear respuesta JSON
            try {
                data = await res.json();
                console.log('[CONFIG] Datos del servidor:', data);
            } catch (parseErr) {
                console.error('[CONFIG] Error parseando JSON:', parseErr);
                messageEl.textContent = '‚ùå Error procesando respuesta del servidor';
                messageEl.className = 'form-message error';
                return;
            }

            // FASE 3: Procesar resultado
            if (res.ok && data.success) {
                messageEl.textContent = '‚úÖ Datos guardados correctamente';
                messageEl.className = 'form-message success';
                
                // Actualizar navbar
                try {
                    document.getElementById('userNameMobile').innerText = username;
                    document.getElementById('userTeamMobile').innerText = escuderia || 'Escuder√≠a';
                    document.documentElement.lang = language;
                } catch (navErr) {
                    console.warn('[CONFIG] Error actualizando navbar:', navErr);
                }
                
                // Recargar traducciones en segundo plano (no bloquea el √©xito)
                if (window.i18n && typeof window.i18n.loadTranslations === 'function') {
                    console.log('[CONFIG] Recargando traducciones para:', language);
                    window.i18n.loadTranslations(language).then(() => {
                        if (typeof window.i18n.applyTranslations === 'function') {
                            window.i18n.applyTranslations();
                        }
                        console.log('[CONFIG] Traducciones aplicadas');
                    }).catch(err => {
                        console.warn('[CONFIG] Traducciones no recargadas (no cr√≠tico):', err.message);
                    });
                }
            } else {
                // El servidor respondi√≥ con error
                messageEl.textContent = '‚ùå ' + (data.error || 'Error al guardar');
                messageEl.className = 'form-message error';
            }
        });

        // Solicitar cambio de contrase√±a
        document.getElementById('btnRequestPassword').addEventListener('click', async () => {
            const messageEl = document.getElementById('passwordMessage');

            try {
                const res = await fetch('/api/request-password-change', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await res.json();

                if (res.ok) {
                    messageEl.textContent = '‚úÖ Se ha enviado un enlace a tu correo electr√≥nico';
                    messageEl.className = 'form-message success';
                } else {
                    messageEl.textContent = '‚ùå ' + (data.error || 'Error al solicitar');
                    messageEl.className = 'form-message error';
                }
            } catch (err) {
                messageEl.textContent = '‚ùå Error de conexi√≥n';
                messageEl.className = 'form-message error';
            }
        });

        // Modal de eliminar cuenta
        const deleteModal = document.getElementById('deleteModal');
        const deleteInput = document.getElementById('deleteConfirmInput');
        const btnConfirmDelete = document.getElementById('btnConfirmDelete');

        function showDeleteConfirm() {
            deleteModal.classList.add('active');
            deleteInput.value = '';
            btnConfirmDelete.disabled = true;
        }

        function hideDeleteModal() {
            deleteModal.classList.remove('active');
        }

        deleteInput.addEventListener('input', (e) => {
            btnConfirmDelete.disabled = e.target.value !== 'ELIMINAR';
        });

        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                hideDeleteModal();
            }
        });

        function deleteAccount() {
            if (deleteInput.value !== 'ELIMINAR') return;
            alert('Funci√≥n de eliminaci√≥n de cuenta - pendiente de implementar en el servidor');
        }
        
        // ========================================
        // SISTEMA DE AVATARES 2D ESTILO RETRATO
        // ========================================
        
        // Generador determinista
        class SeededRandom {
            constructor(seed) {
                this.seed = seed;
            }
            next() {
                this.seed = (this.seed * 9301 + 49297) % 233280;
                return this.seed / 233280;
            }
            range(min, max) {
                return min + this.next() * (max - min);
            }
            int(min, max) {
                return Math.floor(this.range(min, max + 1));
            }
            pick(arr) {
                return arr[this.int(0, arr.length - 1)];
            }
        }
        
        // Crear avatar 2D estilo retrato de calidad
        function createAvatar3D(piloto) {
            const rng = new SeededRandom(piloto.id * 1000);
            const edad = piloto.edad || 25;
            const peso = piloto.peso || 70;
            
            // Colores de piel con m√°s variedad
            const skinTones = [
                { base: '#f5d0c5', shadow: '#e8bfb0', highlight: '#fff0eb' },
                { base: '#e8beac', shadow: '#d4a895', highlight: '#f5d8c8' },
                { base: '#d4a574', shadow: '#c09060', highlight: '#e8ba8a' },
                { base: '#c68642', shadow: '#a86d30', highlight: '#daa05a' },
                { base: '#8d5524', shadow: '#70401a', highlight: '#a86d35' },
                { base: '#f1c27d', shadow: '#d4a865', highlight: '#ffd4a0' },
                { base: '#ffdbac', shadow: '#e8c495', highlight: '#fff0d8' },
                { base: '#c9a66b', shadow: '#b08a50', highlight: '#e0c080' }
            ];
            const skin = rng.pick(skinTones);
            
            // Factor de peso para forma de cara
            const weightFactor = Math.max(-1, Math.min(1, (peso - 70) / 25));
            const faceWidth = 42 + weightFactor * 8;
            const jawWidth = 30 + weightFactor * 10;
            
            // Color de pelo seg√∫n edad
            let hairColor, hairShadow;
            if (edad >= 50) {
                hairColor = rng.next() < 0.6 ? '#c0c0c0' : (rng.next() < 0.5 ? '#a0a0a0' : '#808080');
                hairShadow = '#909090';
            } else if (edad >= 40) {
                hairColor = rng.next() < 0.35 ? '#a0a0a0' : rng.pick(['#2a1a0a', '#3d2817', '#1a1a1a', '#4a3020']);
                hairShadow = '#1a1a1a';
            } else {
                const hairColors = ['#0a0a0a', '#1a1008', '#2a1a0a', '#3d2817', '#4a3020', '#6b4423', '#8b5a2b', '#a0522d', '#d4a574'];
                hairColor = rng.pick(hairColors);
                hairShadow = '#0a0a0a';
            }
            
            // Color de ojos
            const eyeColors = ['#3d2314', '#4a3020', '#2a1a0a', '#1a3a5c', '#0d4a7a', '#2e5a3a', '#4a6a2a'];
            const eyeColor = rng.pick(eyeColors);
            
            // Estilo de pelo
            const hairStyle = rng.int(0, 6);
            const isBald = edad >= 45 ? rng.next() < 0.25 : (edad >= 35 ? rng.next() < 0.1 : rng.next() < 0.02);
            
            // Caracter√≠sticas faciales
            const hasGlasses = edad >= 35 && rng.next() < (edad - 30) * 0.03;
            const hasBeard = edad >= 25 && rng.next() < Math.min(0.6, (edad - 20) * 0.02);
            const beardStyle = hasBeard ? rng.int(0, 3) : -1;
            const hasMustache = edad >= 25 && rng.next() < 0.25;
            
            // Tipo de cara
            const faceShapes = ['oval', 'round', 'square', 'heart', 'oblong'];
            const faceShape = rng.pick(faceShapes);
            
            // Generar SVG
            let svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 250" width="200" height="250">`;
            
            // Definiciones (gradientes, filtros)
            svg += `<defs>
                <radialGradient id="skinGrad" cx="40%" cy="30%" r="70%">
                    <stop offset="0%" stop-color="${skin.highlight}"/>
                    <stop offset="50%" stop-color="${skin.base}"/>
                    <stop offset="100%" stop-color="${skin.shadow}"/>
                </radialGradient>
                <radialGradient id="hairGrad" cx="50%" cy="30%" r="80%">
                    <stop offset="0%" stop-color="${hairColor}"/>
                    <stop offset="100%" stop-color="${hairShadow}"/>
                </radialGradient>
                <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                    <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.2"/>
                </filter>
                <filter id="softShadow" x="-50%" y="-50%" width="200%" height="200%">
                    <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>
                    <feOffset dx="0" dy="1" result="offsetblur"/>
                    <feComponentTransfer><feFuncA type="linear" slope="0.3"/></feComponentTransfer>
                    <feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
            </defs>`;
            
            // Fondo circular
            svg += `<circle cx="100" cy="115" r="95" fill="#f0f0f0"/>`;
            
            // Cuello
            const neckWidth = 25 + weightFactor * 5;
            svg += `<ellipse cx="100" cy="220" rx="${neckWidth}" ry="35" fill="url(#skinGrad)"/>`;
            svg += `<rect x="${100 - neckWidth}" y="185" width="${neckWidth * 2}" height="40" fill="${skin.base}"/>`;
            
            // Forma de la cara seg√∫n tipo
            let facePath;
            const fw = faceWidth;
            const jw = jawWidth;
            switch(faceShape) {
                case 'oval':
                    facePath = `M100,35 C${55 - weightFactor*3},35 ${35 - weightFactor*5},75 ${35 - weightFactor*5},115 C${35 - weightFactor*5},160 ${60 - weightFactor*4},195 100,200 C${140 + weightFactor*4},195 ${165 + weightFactor*5},160 ${165 + weightFactor*5},115 C${165 + weightFactor*5},75 ${145 + weightFactor*3},35 100,35`;
                    break;
                case 'round':
                    facePath = `M100,40 C${55 - weightFactor*4},40 ${40 - weightFactor*5},90 ${40 - weightFactor*5},115 C${40 - weightFactor*5},165 ${70 - weightFactor*3},195 100,195 C${130 + weightFactor*3},195 ${160 + weightFactor*5},165 ${160 + weightFactor*5},115 C${160 + weightFactor*5},90 ${145 + weightFactor*4},40 100,40`;
                    break;
                case 'square':
                    facePath = `M100,38 C${60 - weightFactor*3},38 ${42 - weightFactor*4},70 ${42 - weightFactor*4},115 L${50 - weightFactor*2},195 C${70 - weightFactor*3},198 100,200 100,200 C100,200 ${130 + weightFactor*3},198 ${150 + weightFactor*2},195 L${158 + weightFactor*4},115 C${158 + weightFactor*4},70 ${140 + weightFactor*3},38 100,38`;
                    break;
                case 'heart':
                    facePath = `M100,35 C${55 - weightFactor*3},35 ${38 - weightFactor*4},80 ${38 - weightFactor*4},110 C${38 - weightFactor*4},130 ${45 - weightFactor*3},150 ${60 - weightFactor*2},175 C${75 - weightFactor},190 100,200 100,200 C100,200 ${125 + weightFactor},190 ${140 + weightFactor*2},175 C${155 + weightFactor*3},150 ${162 + weightFactor*4},130 ${162 + weightFactor*4},110 C${162 + weightFactor*4},80 ${145 + weightFactor*3},35 100,35`;
                    break;
                default: // oblong
                    facePath = `M100,30 C${60 - weightFactor*3},30 ${45 - weightFactor*4},85 ${45 - weightFactor*4},115 C${45 - weightFactor*4},165 ${70 - weightFactor*3},200 100,205 C${130 + weightFactor*3},200 ${155 + weightFactor*4},165 ${155 + weightFactor*4},115 C${155 + weightFactor*4},85 ${140 + weightFactor*3},30 100,30`;
            }
            svg += `<path d="${facePath}" fill="url(#skinGrad)" filter="url(#shadow)"/>`;
            
            // Orejas
            const earY = 100 + rng.int(-5, 5);
            svg += `<ellipse cx="${58 - weightFactor*2}" cy="${earY}" rx="12" ry="18" fill="${skin.base}"/>`;
            svg += `<ellipse cx="${58 - weightFactor*2}" cy="${earY}" rx="7" ry="12" fill="${skin.shadow}"/>`;
            svg += `<ellipse cx="${142 + weightFactor*2}" cy="${earY}" rx="12" ry="18" fill="${skin.base}"/>`;
            svg += `<ellipse cx="${142 + weightFactor*2}" cy="${earY}" rx="7" ry="12" fill="${skin.shadow}"/>`;
            
            // PELO (si no es calvo)
            if (!isBald) {
                svg += generateHairStyle(hairStyle, hairColor, hairShadow, fw, weightFactor, rng);
            } else if (edad >= 35) {
                // Pelo lateral para calvos
                svg += `<ellipse cx="${65 - weightFactor*2}" cy="60" rx="20" ry="25" fill="url(#hairGrad)"/>`;
                svg += `<ellipse cx="${135 + weightFactor*2}" cy="60" rx="20" ry="25" fill="url(#hairGrad)"/>`;
            }
            
            // L√≠neas de expresi√≥n (arrugas seg√∫n edad)
            if (edad >= 35) {
                const wrinkleOpacity = Math.min(0.4, (edad - 30) * 0.01);
                // L√≠neas de la frente
                svg += `<path d="M75,55 Q100,${52 - (edad-35)*0.1} 125,55" stroke="${skin.shadow}" stroke-width="0.5" fill="none" opacity="${wrinkleOpacity}"/>`;
                if (edad >= 45) {
                    svg += `<path d="M80,62 Q100,${59 - (edad-45)*0.1} 120,62" stroke="${skin.shadow}" stroke-width="0.5" fill="none" opacity="${wrinkleOpacity * 0.7}"/>`;
                }
                // Patas de gallo
                svg += `<path d="M55,95 Q50,100 45,108" stroke="${skin.shadow}" stroke-width="0.8" fill="none" opacity="${wrinkleOpacity}"/>`;
                svg += `<path d="M145,95 Q150,100 155,108" stroke="${skin.shadow}" stroke-width="0.8" fill="none" opacity="${wrinkleOpacity}"/>`;
            }
            
            // Cejas con personalidad
            const eyebrowStyle = rng.int(0, 3);
            const eyebrowY = 75 + rng.int(-3, 3);
            const eyebrowColor = edad >= 50 ? '#808080' : (edad >= 40 ? rng.pick(['#3a3a3a', '#4a4a4a', '#2a1a0a']) : '#1a0a00');
            svg += generateEyebrows(eyebrowStyle, eyebrowY, eyebrowColor, rng);
            
            // Ojos detallados
            const eyeY = 95 + rng.int(-3, 3);
            const eyeSpacing = 28 + rng.int(-3, 3);
            const eyeShape = rng.int(0, 2);
            svg += generateEyes(eyeY, eyeSpacing, eyeColor, eyeShape, skin, rng);
            
            // Gafas
            if (hasGlasses) {
                svg += generateGlasses(eyeY, eyeSpacing, rng);
            }
            
            // Nariz
            const noseStyle = rng.int(0, 3);
            svg += generateNose(noseStyle, skin, rng, peso);
            
            // Barba/bigote
            if (hasMustache) {
                svg += generateMustache(beardStyle, hairColor, hairShadow, rng);
            }
            if (hasBeard && beardStyle >= 0) {
                svg += generateBeard(beardStyle, hairColor, hairShadow, weightFactor, rng);
            }
            
            // Boca
            const mouthY = 155 + rng.int(-5, 5);
            const mouthStyle = rng.int(0, 2);
            svg += generateMouth(mouthY, mouthStyle, skin, rng);
            
            // Mejillas sonrojadas si peso alto
            if (peso > 85) {
                svg += `<ellipse cx="${70 - weightFactor}" cy="135" rx="15" ry="10" fill="#ffb6c1" opacity="0.2"/>`;
                svg += `<ellipse cx="${130 + weightFactor}" cy="135" rx="15" ry="10" fill="#ffb6c1" opacity="0.2"/>`;
            }
            
            svg += `</svg>`;
            
            // Convertir SVG a PNG via canvas
            return svgToPngBase64(svg);
        }
        
        // Funciones auxiliares para generar partes del avatar
        function generateHairStyle(style, color, shadow, fw, weightFactor, rng) {
            let svg = '';
            switch(style) {
                case 0: // Pelo corto moderno
                    svg += `<ellipse cx="100" cy="50" rx="${fw + 5}" ry="35" fill="url(#hairGrad)"/>`;
                    svg += `<path d="M${60 - weightFactor*2},35 Q100,20 ${140 + weightFactor*2},35 Q100,25 ${60 - weightFactor*2},35" fill="url(#hairGrad)"/>`;
                    break;
                case 1: // Flequillo
                    svg += `<ellipse cx="100" cy="45" rx="${fw + 8}" ry="40" fill="url(#hairGrad)"/>`;
                    svg += `<path d="M${65 - weightFactor*2},55 Q75,85 ${90 - weightFactor},65 Q100,95 ${110 + weightFactor},65 Q125,85 ${135 + weightFactor*2},55" fill="url(#hairGrad)"/>`;
                    break;
                case 2: // Pelo hacia atr√°s
                    svg += `<ellipse cx="100" cy="42" rx="${fw}" ry="32" fill="url(#hairGrad)"/>`;
                    svg += `<path d="M${58 - weightFactor*2},60 Q100,30 ${142 + weightFactor*2},60" fill="url(#hairGrad)"/>`;
                    break;
                case 3: // Pelo lateral/raya al lado
                    svg += `<ellipse cx="100" cy="48" rx="${fw + 6}" ry="38" fill="url(#hairGrad)"/>`;
                    svg += `<path d="M${65 - weightFactor*2},40 Q85,60 ${95 - weightFactor},45 Q100,70 ${130 + weightFactor*2},50" fill="url(#hairGrad)"/>`;
                    break;
                case 4: // Pelo largo
                    svg += `<ellipse cx="100" cy="45" rx="${fw + 10}" ry="45" fill="url(#hairGrad)"/>`;
                    svg += `<path d="M${55 - weightFactor*3},50 Q50,120 ${60 - weightFactor*2},180" stroke="url(#hairGrad)" stroke-width="25" fill="none"/>`;
                    svg += `<path d="M${145 + weightFactor*3},50 Q150,120 ${140 + weightFactor*2},180" stroke="url(#hairGrad)" stroke-width="25" fill="none"/>`;
                    break;
                case 5: // Afro/voluminoso
                    svg += `<circle cx="100" cy="55" r="${fw + 15}" fill="url(#hairGrad)"/>`;
                    svg += `<circle cx="85" cy="40" r="20" fill="url(#hairGrad)"/>`;
                    svg += `<circle cx="115" cy="40" r="20" fill="url(#hairGrad)"/>`;
                    svg += `<circle cx="100" cy="30" r="18" fill="url(#hairGrad)"/>`;
                    break;
                case 6: // Rapado/cepillado
                    svg += `<ellipse cx="100" cy="50" rx="${fw}" ry="25" fill="${color}" opacity="0.7"/>`;
                    break;
            }
            return svg;
        }
        
        function generateEyebrows(style, y, color, rng) {
            let svg = '';
            const thickness = 3 + rng.int(0, 3);
            switch(style) {
                case 0: // Normal
                    svg += `<path d="M65,${y} Q80,${y-5} 85,${y}" stroke="${color}" stroke-width="${thickness}" fill="none" stroke-linecap="round"/>`;
                    svg += `<path d="M115,${y} Q120,${y-5} 135,${y}" stroke="${color}" stroke-width="${thickness}" fill="none" stroke-linecap="round"/>`;
                    break;
                case 1: // Arqueadas
                    svg += `<path d="M68,${y+3} Q77,${y-8} 88,${y+2}" stroke="${color}" stroke-width="${thickness}" fill="none" stroke-linecap="round"/>`;
                    svg += `<path d="M112,${y+2} Q123,${y-8} 132,${y+3}" stroke="${color}" stroke-width="${thickness}" fill="none" stroke-linecap="round"/>`;
                    break;
                case 2: // Rectas
                    svg += `<line x1="65" y1="${y}" x2="90" y2="${y}" stroke="${color}" stroke-width="${thickness}" stroke-linecap="round"/>`;
                    svg += `<line x1="110" y1="${y}" x2="135" y2="${y}" stroke="${color}" stroke-width="${thickness}" stroke-linecap="round"/>`;
                    break;
                case 3: // M√°s gruesas/pobladas
                    svg += `<path d="M62,${y+2} Q77,${y-4} 90,${y+1}" stroke="${color}" stroke-width="${thickness + 2}" fill="none" stroke-linecap="round"/>`;
                    svg += `<path d="M110,${y+1} Q123,${y-4} 138,${y+2}" stroke="${color}" stroke-width="${thickness + 2}" fill="none" stroke-linecap="round"/>`;
                    break;
            }
            return svg;
        }
        
        function generateEyes(y, spacing, eyeColor, shape, skin, rng) {
            let svg = '';
            const leftX = 100 - spacing;
            const rightX = 100 + spacing;
            
            // Cuencas de los ojos
            svg += `<ellipse cx="${leftX}" cy="${y}" rx="14" ry="9" fill="${skin.shadow}" opacity="0.3"/>`;
            svg += `<ellipse cx="${rightX}" cy="${y}" rx="14" ry="9" fill="${skin.shadow}" opacity="0.3"/>`;
            
            // Forma del ojo
            let eyePath;
            switch(shape) {
                case 0: // Almendrado
                    eyePath = `M${leftX-10},${y} Q${leftX},${y-7} ${leftX+10},${y} Q${leftX},${y+6} ${leftX-10},${y}`;
                    break;
                case 1: // Redondo
                    eyePath = `M${leftX-10},${y} Q${leftX-10},${y-8} ${leftX},${y-8} Q${leftX+10},${y-8} ${leftX+10},${y} Q${leftX+10},${y+8} ${leftX},${y+8} Q${leftX-10},${y+8} ${leftX-10},${y}`;
            eyePath = `M${leftX-10},${y} Q${leftX-12},${y-7} ${leftX},${y-7} Q${leftX+12},${y-7} ${leftX+10},${y}`;
            break;
                default: // Normal
                    eyePath = `M${leftX-11},${y} Q${leftX},${y-6} ${leftX+11},${y} Q${leftX},${y+5} ${leftX-11},${y}`;
            }
            
            // Blancos de los ojos
            svg += `<ellipse cx="${leftX}" cy="${y}" rx="11" ry="7" fill="white"/>`;
            svg += `<ellipse cx="${rightX}" cy="${y}" rx="11" ry="7" fill="white"/>`;
            
            // Iris
            const irisSize = 5 + rng.int(0, 2);
            svg += `<circle cx="${leftX}" cy="${y}" r="${irisSize}" fill="${eyeColor}"/>`;
            svg += `<circle cx="${rightX}" cy="${y}" r="${irisSize}" fill="${eyeColor}"/>`;
            
            // Pupilas
            svg += `<circle cx="${leftX}" cy="${y}" r="2.5" fill="black"/>`;
            svg += `<circle cx="${rightX}" cy="${y}" r="2.5" fill="black"/>`;
            
            // Brillos
            svg += `<circle cx="${leftX + 2}" cy="${y - 2}" r="1.5" fill="white"/>`;
            svg += `<circle cx="${rightX + 2}" cy="${y - 2}" r="1.5" fill="white"/>`;
            
            // P√°rpados
            svg += `<path d="M${leftX-12},${y-1} Q${leftX},${y-8} ${leftX+12},${y-1}" stroke="${skin.shadow}" stroke-width="1.5" fill="none"/>`;
            svg += `<path d="M${rightX-12},${y-1} Q${rightX},${y-8} ${rightX+12},${y-1}" stroke="${skin.shadow}" stroke-width="1.5" fill="none"/>`;
            
            // Pesta√±as superiores
            svg += `<path d="M${leftX-10},${y-5} L${leftX-12},${y-9} M${leftX-5},${y-7} L${leftX-5},${y-11} M${leftX},${y-7} L${leftX},${y-11} M${leftX+5},${y-7} L${leftX+5},${y-11} M${leftX+10},${y-5} L${leftX+12},${y-9}" stroke="black" stroke-width="1" fill="none"/>`;
            svg += `<path d="M${rightX-10},${y-5} L${rightX-12},${y-9} M${rightX-5},${y-7} L${rightX-5},${y-11} M${rightX},${y-7} L${rightX},${y-11} M${rightX+5},${y-7} L${rightX+5},${y-11} M${rightX+10},${y-5} L${rightX+12},${y-9}" stroke="black" stroke-width="1" fill="none"/>`;
            
            return svg;
        }
        
        function generateNose(style, skin, rng, peso) {
            let svg = '';
            const noseY = 120;
            const noseWidth = 8 + (peso - 70) * 0.1;
            
            switch(style) {
                case 0: // Nariz recta
                    svg += `<path d="M100,${noseY - 20} L100,${noseY + 10} M${100 - noseWidth},${noseY + 8} Q100,${noseY + 15} ${100 + noseWidth},${noseY + 8}" stroke="${skin.shadow}" stroke-width="2" fill="none"/>`;
                    break;
                case 1: // Nariz aguile√±a
                    svg += `<path d="M100,${noseY - 20} Q95,${noseY} 100,${noseY + 5} M${100 - noseWidth},${noseY + 8} Q100,${noseY + 15} ${100 + noseWidth},${noseY + 8}" stroke="${skin.shadow}" stroke-width="2" fill="none"/>`;
                    break;
                case 2: // Nariz peque√±a
                    svg += `<path d="M100,${noseY - 10} L100,${noseY + 5} M${100 - noseWidth},${noseY + 3} Q100,${noseY + 8} ${100 + noseWidth},${noseY + 3}" stroke="${skin.shadow}" stroke-width="1.5" fill="none"/>`;
                    break;
                default: // Nariz ancha
                    svg += `<path d="M100,${noseY - 20} L100,${noseY + 5} M${100 - noseWidth - 3},${noseY + 10} Q100,${noseY + 18} ${100 + noseWidth + 3},${noseY + 10}" stroke="${skin.shadow}" stroke-width="2" fill="none"/>`;
                    svg += `<ellipse cx="${100 - noseWidth - 2}" cy="${noseY + 8}" rx="4" ry="3" fill="${skin.shadow}" opacity="0.3"/>`;
                    svg += `<ellipse cx="${100 + noseWidth + 2}" cy="${noseY + 8}" rx="4" ry="3" fill="${skin.shadow}" opacity="0.3"/>`;
            }
            return svg;
        }
        
        function generateMustache(style, color, shadow, rng) {
            let svg = '';
            const y = 148;
            svg += `<path d="M80,${y} Q90,${y + 5} 100,${y + 2} Q110,${y + 5} 120,${y}" stroke="${color}" stroke-width="4" fill="none" stroke-linecap="round"/>`;
            return svg;
        }
        
        function generateBeard(style, color, shadow, weightFactor, rng) {
            let svg = '';
            const beardOpacity = 0.8;
            
            switch(style) {
                case 0: // Barba completa corta
                    svg += `<ellipse cx="100" cy="175" rx="${40 + weightFactor*3}" ry="30" fill="${color}" opacity="${beardOpacity}"/>`;
                    svg += `<ellipse cx="100" cy="165" rx="${45 + weightFactor*3}" ry="20" fill="${color}" opacity="${beardOpacity}"/>`;
                    break;
                case 1: // Perilla
                    svg += `<ellipse cx="100" cy="185" rx="12" ry="18" fill="${color}" opacity="${beardOpacity}"/>`;
                    break;
                case 2: // Barba de 3 d√≠as
                    svg += `<ellipse cx="100" cy="170" rx="${35 + weightFactor*2}" ry="25" fill="${color}" opacity="0.4"/>`;
                    break;
                case 3: // Barba estilo ancla
                    svg += `<path d="M85,160 Q100,165 115,160 L115,175 Q100,200 85,175 Z" fill="${color}" opacity="${beardOpacity}"/>`;
                    svg += `<ellipse cx="100" cy="190" rx="10" ry="15" fill="${color}" opacity="${beardOpacity}"/>`;
                    break;
            }
            return svg;
        }
        
        function generateGlasses(eyeY, spacing, rng) {
            let svg = '';
            const leftX = 100 - spacing;
            const rightX = 100 + spacing;
            
            const frameColor = rng.pick(['#1a1a1a', '#2c2c2c', '#4a3020', '#8b4513']);
            const frameStyle = rng.int(0, 2);
            
            switch(frameStyle) {
                case 0: // Redondos
                    svg += `<circle cx="${leftX}" cy="${eyeY}" r="17" fill="none" stroke="${frameColor}" stroke-width="2.5"/>`;
                    svg += `<circle cx="${rightX}" cy="${eyeY}" r="17" fill="none" stroke="${frameColor}" stroke-width="2.5"/>`;
                    svg += `<ellipse cx="${leftX}" cy="${eyeY}" rx="14" ry="10" fill="rgba(135,206,235,0.1)"/>`;
                    svg += `<ellipse cx="${rightX}" cy="${eyeY}" rx="14" ry="10" fill="rgba(135,206,235,0.1)"/>`;
                    break;
                case 1: // Rectangulares
                    svg += `<rect x="${leftX - 15}" y="${eyeY - 10}" width="30" height="18" rx="3" fill="none" stroke="${frameColor}" stroke-width="2.5"/>`;
                    svg += `<rect x="${rightX - 15}" y="${eyeY - 10}" width="30" height="18" rx="3" fill="none" stroke="${frameColor}" stroke-width="2.5"/>`;
                    svg += `<rect x="${leftX - 13}" y="${eyeY - 8}" width="26" height="14" rx="2" fill="rgba(135,206,235,0.1)"/>`;
                    svg += `<rect x="${rightX - 13}" y="${eyeY - 8}" width="26" height="14" rx="2" fill="rgba(135,206,235,0.1)"/>`;
                    break;
                case 2: // Aviador
                    svg += `<path d="M${leftX - 16},${eyeY - 5} Q${leftX - 18},${eyeY + 12} ${leftX},${eyeY + 10} Q${leftX + 18},${eyeY + 12} ${leftX + 16},${eyeY - 5}" fill="none" stroke="${frameColor}" stroke-width="2.5"/>`;
                    svg += `<path d="M${rightX - 16},${eyeY - 5} Q${rightX - 18},${eyeY + 12} ${rightX},${eyeY + 10} Q${rightX + 18},${eyeY + 12} ${rightX + 16},${eyeY - 5}" fill="none" stroke="${frameColor}" stroke-width="2.5"/>`;
                    svg += `<path d="M${leftX - 14},${eyeY - 3} Q${leftX - 16},${eyeY + 9} ${leftX},${eyeY + 7} Q${leftX + 16},${eyeY + 9} ${leftX + 14},${eyeY - 3}" fill="rgba(135,206,235,0.15)"/>`;
                    svg += `<path d="M${rightX - 14},${eyeY - 3} Q${rightX - 16},${eyeY + 9} ${rightX},${eyeY + 7} Q${rightX + 16},${eyeY + 9} ${rightX + 14},${eyeY - 3}" fill="rgba(135,206,235,0.15)"/>`;
                    break;
            }
            
            // Puente
            svg += `<line x1="${leftX + 17}" y1="${eyeY}" x2="${rightX - 17}" y2="${eyeY}" stroke="${frameColor}" stroke-width="2"/>`;
            
            // Patillas
            svg += `<line x1="${leftX - 17}" y1="${eyeY}" x2="${leftX - 25}" y2="${eyeY - 5}" stroke="${frameColor}" stroke-width="2"/>`;
            svg += `<line x1="${rightX + 17}" y1="${eyeY}" x2="${rightX + 25}" y2="${eyeY - 5}" stroke="${frameColor}" stroke-width="2"/>`;
            
            return svg;
        }
        
        function generateMouth(y, style, skin, rng) {
            let svg = '';
            const mouthWidth = 18 + rng.int(-3, 5);
            const lipColor = rng.pick(['#c17f7f', '#d4918a', '#b86b6b', '#a05a5a']);
            
            switch(style) {
                case 0: // Sonrisa natural
                    svg += `<path d="M${100 - mouthWidth},${y} Q100,${y + 12} ${100 + mouthWidth},${y}" stroke="${lipColor}" stroke-width="3" fill="none" stroke-linecap="round"/>`;
                    break;
                case 1: // Boca seria
                    svg += `<line x1="${100 - mouthWidth}" y1="${y}" x2="${100 + mouthWidth}" y2="${y}" stroke="${lipColor}" stroke-width="3" stroke-linecap="round"/>`;
                    break;
                case 2: // Media sonrisa
                    svg += `<path d="M${100 - mouthWidth},${y} Q100,${y + 8} ${100 + mouthWidth},${y - 2}" stroke="${lipColor}" stroke-width="3" fill="none" stroke-linecap="round"/>`;
                    break;
            }
            
            // Labio inferior
            svg += `<path d="M${100 - mouthWidth + 5},${y + 5} Q100,${y + 10} ${100 + mouthWidth - 5},${y + 5}" fill="${lipColor}" opacity="0.6"/>`;
            
            return svg;
        }
        
        // Convertir SVG a PNG base64
        function svgToPngBase64(svgString) {
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 250;
            const ctx = canvas.getContext('2d');
            
            const img = new Image();
            const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(svgBlob);
            
            return new Promise((resolve) => {
                img.onload = function() {
                    ctx.drawImage(img, 0, 0);
                    URL.revokeObjectURL(url);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.src = url;
            });
        }
        
        // ========================================
        // FUNCIONES DE ADMINISTRADOR
        // ========================================
        
        // Cargar estado de avatares al iniciar
        async function loadAvatarsStatus() {
            if (!isAdmin) return;
            
            try {
                const res = await fetch('/api/admin/avatars-status');
                const data = await res.json();
                
                const statusInfo = document.getElementById('avatarStatusInfo');
                if (data.total === 0) {
                    statusInfo.innerHTML = '<span style="color: #888;">‚ÑπÔ∏è No hay pilotos en la base de datos</span>';
                } else if (data.todosCompletos) {
                    statusInfo.innerHTML = `<span style="color: #00c853;">‚úÖ Todos los avatares est√°n generados (${data.total}/${data.total})</span>`;
                } else {
                    statusInfo.innerHTML = `<span style="color: #ff9800;">‚ö†Ô∏è Avatares pendientes: ${data.sinAvatar} de ${data.total}</span>`;
                }
            } catch (err) {
                console.error('Error cargando estado de avatares:', err);
            }
        }
        
        // Verificar y generar avatares
        async function checkAndGenerateAvatars() {
            const btn = document.getElementById('btnGenerateAvatars');
            btn.disabled = true;
            
            try {
                // Verificar estado actual
                showProgressModal({
                    type: 'loading',
                    title: 'Verificando avatares',
                    text: 'Consultando base de datos...'
                });
                
                const statusRes = await fetch('/api/admin/avatars-status');
                const statusData = await statusRes.json();
                
                if (statusData.todosCompletos) {
                    showProgressModal({
                        type: 'warning',
                        title: 'Avatares ya generados',
                        text: `Todos los ${statusData.total} pilotos ya tienen avatar.`,
                        showClose: true
                    });
                    btn.disabled = false;
                    return;
                }
                
                if (statusData.total === 0) {
                    showProgressModal({
                        type: 'info',
                        title: 'Sin pilotos',
                        text: 'No hay pilotos en la base de datos para generar avatares.',
                        showClose: true
                    });
                    btn.disabled = false;
                    return;
                }
                
                // Obtener lista de pilotos sin avatar
                showProgressModal({
                    type: 'loading',
                    title: 'Generando Avatares',
                    text: `Preparando ${statusData.sinAvatar} avatares...`,
                    total: statusData.sinAvatar,
                    current: 0
                });
                
                const pilotosRes = await fetch('/api/admin/pilotos-sin-avatar');
                const pilotos = await pilotosRes.json();
                
                if (!pilotos.length) {
                    showProgressModal({
                        type: 'info',
                        title: 'Sin cambios',
                        text: 'Todos los pilotos ya tienen avatar.',
                        showClose: true
                    });
                    btn.disabled = false;
                    return;
                }
                
                // Generar avatares uno por uno
                let processed = 0;
                const total = pilotos.length;
                const errors = [];
                
                for (const piloto of pilotos) {
                    try {
                        // Actualizar UI
                        updateProgress(processed, total, piloto.nombre);
                        
                        // Generar avatar 2D estilo retrato (devuelve Promise PNG base64)
                        const avatarData = await createAvatar3D(piloto);
                        
                        // Guardar en servidor
                        const saveRes = await fetch('/api/admin/save-avatar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                pilotoId: piloto.id, 
                                avatar: avatarData 
                            })
                        });
                        
                        if (!saveRes.ok) {
                            throw new Error('Error al guardar');
                        }
                        
                        // Mostrar preview del primer avatar
                        if (processed === 0) {
                            document.getElementById('avatarPreview').innerHTML = 
                                `<img src="${avatarData}" style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid #ffc107;">`;
                        }
                        
                    } catch (err) {
                        errors.push(`${piloto.nombre}: ${err.message}`);
                    }
                    
                    processed++;
                }
                
                // Completar
                completeProgress({
                    updated: processed,
                    total: total,
                    errors: errors
                });
                
                // Recargar estado
                await loadAvatarsStatus();
                
            } catch (err) {
                showProgressModal({
                    type: 'error',
                    title: 'Error',
                    text: err.message,
                    showClose: true
                });
            } finally {
                btn.disabled = false;
            }
        }
        
        // Actualizar progreso
        function updateProgress(current, total, nombre) {
            const percent = Math.round(((current + 1) / total) * 100);
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressPercent').textContent = percent + '%';
            document.getElementById('progressDetails').innerHTML = 
                `<span style="color: #ffc107;">Procesando: ${current + 1}/${total}</span><br>
                 <span style="color: #fff; font-size: 12px;">${nombre}</span>`;
        }
        
        // Completar progreso
        function completeProgress(data) {
            const progressFill = document.getElementById('progressFill');
            const progressPercent = document.getElementById('progressPercent');
            const progressDetails = document.getElementById('progressDetails');
            const progressTitle = document.getElementById('progressTitle');
            const progressText = document.getElementById('progressText');
            const progressIcon = document.getElementById('progressIcon');
            const progressCloseBtn = document.getElementById('progressCloseBtn');
            
            progressFill.style.width = '100%';
            progressPercent.textContent = '100%';
            progressFill.style.background = 'linear-gradient(90deg, #00c853, #69f0ae)';
            
            progressIcon.textContent = '‚úÖ';
            progressTitle.textContent = '¬°Proceso Completado!';
            progressText.textContent = `Se generaron ${data.updated} avatares correctamente.`;
            
            if (data.errors && data.errors.length > 0) {
                progressDetails.innerHTML = `
                    <span style="color: #ff9800;">‚ö†Ô∏è ${data.errors.length} errores:</span>
                    <div style="font-size: 11px; color: #888; margin-top: 8px; max-height: 60px; overflow-y: auto;">
                        ${data.errors.map(e => `<div>‚Ä¢ ${e}</div>`).join('')}
                    </div>
                `;
            } else {
                progressDetails.innerHTML = '<span style="color: #00c853;">‚ú® Todos los avatares generados sin errores</span>';
            }
            
            progressCloseBtn.style.display = 'block';
        }
        
        // Mostrar modal de progreso
        function showProgressModal(options) {
            const modal = document.getElementById('progressModal');
            const progressIcon = document.getElementById('progressIcon');
            const progressTitle = document.getElementById('progressTitle');
            const progressText = document.getElementById('progressText');
            const progressContainer = document.getElementById('progressContainer');
            const progressDetails = document.getElementById('progressDetails');
            const progressCloseBtn = document.getElementById('progressCloseBtn');
            const progressFill = document.getElementById('progressFill');
            const avatarPreview = document.getElementById('avatarPreview');
            
            progressFill.style.width = '0%';
            progressFill.style.background = 'linear-gradient(90deg, #ffc107, #ff9800)';
            document.getElementById('progressPercent').textContent = '0%';
            progressCloseBtn.style.display = options.showClose ? 'block' : 'none';
            progressDetails.innerHTML = '';
            avatarPreview.innerHTML = '';
            
            switch(options.type) {
                case 'warning':
                    progressIcon.textContent = '‚ö†Ô∏è';
                    progressContainer.style.display = 'none';
                    break;
                case 'error':
                    progressIcon.textContent = '‚ùå';
                    progressContainer.style.display = 'none';
                    break;
                case 'info':
                    progressIcon.textContent = '‚ÑπÔ∏è';
                    progressContainer.style.display = 'none';
                    break;
                case 'loading':
                    progressIcon.textContent = '‚è≥';
                    progressContainer.style.display = 'block';
                    break;
                default:
                    progressContainer.style.display = 'none';
            }
            
            progressTitle.textContent = options.title || 'Procesando';
            progressText.textContent = options.text || '';
            
            modal.classList.add('active');
        }
        
        // Cerrar modal de progreso
        function closeProgressModal() {
            document.getElementById('progressModal').classList.remove('active');
        }
        
        // Cerrar al hacer clic fuera
        document.getElementById('progressModal').addEventListener('click', (e) => {
            if (e.target.id === 'progressModal') {
                closeProgressModal();
            }
        });
        
        async function ensureAvatarColumn() {
            const statusEl = document.getElementById('systemStatus');
            const btn = document.getElementById('btnEnsureAvatarColumn');
            
            statusEl.innerHTML = '<span class="loading">‚è≥ Verificando...</span>';
            btn.disabled = true;
            
            try {
                const res = await fetch('/api/admin/ensure-avatar-column', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await res.json();
                
                if (res.ok && data.success) {
                    statusEl.innerHTML = `<span class="success">‚úÖ ${data.message}</span>`;
                } else {
                    statusEl.innerHTML = `<span class="error">‚ùå ${data.error || 'Error desconocido'}</span>`;
                }
            } catch (err) {
                statusEl.innerHTML = `<span class="error">‚ùå Error de conexi√≥n: ${err.message}</span>`;
            } finally {
                btn.disabled = false;
            }
        }
    </script>
    <style>
        /* Estilos del panel de administrador */
        .config-admin {
            background: rgba(255, 193, 7, 0.1);
            border: 2px solid rgba(255, 193, 7, 0.3);
        }
        
        .config-title-admin {
            color: #ffc107;
        }
        
        .admin-tools {
            display: grid;
            gap: 20px;
            margin-top: 16px;
        }
        
        .admin-tool {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 193, 7, 0.2);
        }
        
        .admin-tool h3 {
            margin: 0 0 8px 0;
            color: #fff;
            font-size: 16px;
        }
        
        .admin-tool p {
            margin: 0 0 16px 0;
            color: #aaa;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .btn-admin {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn-admin:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }
        
        .btn-admin:disabled {
            background: #444;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-admin.btn-secondary {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        
        .btn-admin.btn-secondary:hover {
            background: rgba(255, 193, 7, 0.3);
        }
        
        .admin-status {
            margin-top: 12px;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .admin-status .loading {
            color: #ffc107;
        }
        
        .admin-status .success {
            color: #00c853;
        }
        
        .admin-status .error {
            color: #f44336;
        }
        
        /* Modal de progreso */
        .modal-progress {
            max-width: 400px;
            text-align: center;
        }
        
        .modal-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #888;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .modal-close-btn:hover {
            background: rgba(255, 87, 34, 0.3);
            color: #ff5722;
        }
        
        .modal-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .modal-title {
            font-size: 20px;
            margin: 0 0 8px 0;
            color: #fff;
        }
        
        .modal-text {
            font-size: 14px;
            color: #aaa;
            margin: 0 0 20px 0;
        }
        
        .progress-container {
            margin-bottom: 16px;
        }
        
        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffc107, #ff9800);
            border-radius: 6px;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            font-size: 14px;
            color: #fff;
            font-weight: bold;
        }
        
        .progress-details {
            font-size: 13px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-top: 12px;
        }
        
        .admin-status-info {
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 13px;
        }
    </style>
<script src="preload-fondos.js"></script>
</body>
</html>
