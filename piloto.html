<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piloto | Moto Pro Manager</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="cookie-consent.js"></script>
    <script src="background-changer.js"></script>
    <script src="js/i18n.js"></script>
    <style>
        /* Estilos espec√≠ficos de piloto.html */
        .piloto-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .piloto-main-card {
            background: rgba(0, 0, 0, 0.85);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            box-sizing: border-box;
        }

        .piloto-header-section {
            display: flex;
            align-items: center;
            gap: 24px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .piloto-avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e10600, #ff6b6b);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: bold;
            color: white;
            flex-shrink: 0;
        }

        .piloto-main-info {
            flex: 1;
            min-width: 200px;
        }

        .piloto-main-info h1 {
            margin: 0 0 8px 0;
            font-size: 28px;
            color: white;
        }

        .piloto-number-display {
            font-size: 24px;
            color: #e10600;
            font-weight: bold;
        }

        .piloto-meta {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 8px;
            color: #aaa;
        }

        .piloto-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .resistencia-degradacion {
            font-size: 11px;
            color: #ff9800;
            background: rgba(255, 152, 0, 0.15);
            padding: 4px 8px;
            border-radius: 12px;
            white-space: nowrap;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 14px;
            color: #ccc;
        }

        .stat-value-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-bar {
            width: 100px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .stat-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .stat-bar-fill.legendary { background: linear-gradient(90deg, #9c27b0, #e040fb); }
        .stat-bar-fill.excellent { background: linear-gradient(90deg, #2196f3, #64b5f6); }
        .stat-bar-fill.good { background: linear-gradient(90deg, #4caf50, #81c784); }
        .stat-bar-fill.average { background: linear-gradient(90deg, #ffeb3b, #fff176); }
        .stat-bar-fill.poor { background: linear-gradient(90deg, #f44336, #e57373); }
        .stat-bar-fill.bad { background: linear-gradient(90deg, #616161, #9e9e9e); }

        .stat-number {
            font-weight: bold;
            min-width: 30px;
            text-align: right;
        }

        .stat-number.legendary { color: #9c27b0; }
        .stat-number.excellent { color: #2196f3; }
        .stat-number.good { color: #4caf50; }
        .stat-number.average { color: #fbc02d; }
        .stat-number.poor { color: #f44336; }
        .stat-number.bad { color: #757575; }

        /* Secci√≥n de Habilidades unificada */
        .habilidades-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .habilidades-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .habilidades-header h3 {
            margin: 0;
            font-size: 14px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .habilidades-info-popup {
            display: none;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(225, 6, 0, 0.3);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
            animation: fadeIn 0.2s ease;
        }

        .habilidades-info-popup.visible {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .info-popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .info-nav-btn {
            width: 32px;
            height: 32px;
            background: rgba(225, 6, 0, 0.3);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .info-nav-btn:hover {
            background: rgba(225, 6, 0, 0.5);
        }

        .info-popup-title {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            text-align: center;
            flex: 1;
        }

        .info-popup-desc {
            font-size: 13px;
            color: #ccc;
            line-height: 1.6;
            margin: 0 0 12px 0;
            text-align: center;
        }

        .info-popup-dots {
            display: flex;
            justify-content: center;
            gap: 6px;
        }

        .info-popup-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 12px;
        }

        .info-close-btn {
            color: #e10600;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .info-close-btn:hover {
            background: rgba(225, 6, 0, 0.2);
        }

        .info-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.2s;
        }

        .info-dot.active {
            background: #e10600;
            transform: scale(1.2);
        }

        .habilidades-grid {
            display: grid;
            gap: 8px;
        }

        .fisico-info-popup {
            display: none;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(225, 6, 0, 0.3);
            border-radius: 10px;
            padding: 16px;
            margin-top: 12px;
            animation: fadeIn 0.2s ease;
        }

        .fisico-info-popup.visible {
            display: block;
        }

        /* F√≠sico */
        .physical-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 600px) {
            .physical-stats {
                grid-template-columns: 1fr;
            }
        }

        .physical-stat {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 14px;
            text-align: center;
        }

        .physical-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: white;
        }

        .physical-stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }

        .physical-bonus {
            font-size: 12px;
            margin-top: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
        }

        .physical-bonus.positive { color: #00c853; }
        .physical-bonus.negative { color: #ff5252; }
        .physical-bonus.neutral { color: #888; }

        /* Estado del piloto */
        .piloto-status-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
        }

        .status-badge.activo {
            background: rgba(0, 200, 83, 0.2);
            color: #00c853;
            border: 1px solid rgba(0, 200, 83, 0.3);
        }

        .status-badge.lesionado {
            background: rgba(255, 87, 34, 0.2);
            color: #ff5722;
            border: 1px solid rgba(255, 87, 34, 0.3);
        }

        .lesion-info {
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 87, 34, 0.1);
            border-radius: 8px;
            display: none;
        }

        .lesion-info.visible {
            display: block;
        }

        /* Entrenamiento */
        .training-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .training-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .training-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .training-attribute {
            font-weight: 500;
            color: #e10600;
        }

        .training-progress {
            font-size: 14px;
            color: #888;
        }

        .btn-train {
            background: linear-gradient(135deg, #e10600, #ff4444);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-train:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(225, 6, 0, 0.4);
        }

        .btn-train:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Select de entrenamiento */
        .train-select-container {
            display: none;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .train-select-container.visible {
            display: block;
        }

        .train-select-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .train-select {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }

        .train-cost {
            color: #ffc107;
            font-size: 14px;
        }

        .btn-confirm-train {
            background: #00c853;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-cancel-train {
            background: transparent;
            color: #888;
            border: 1px solid #444;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* Sin piloto */
        .no-piloto {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .no-piloto-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .edit-link {
            color: #e10600;
            cursor: pointer;
            font-size: 12px;
            text-decoration: underline;
        }

        .info-icon {
            width: 14px;
            height: 14px;
            background: rgba(225, 6, 0, 0.3);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            font-style: italic;
            cursor: pointer;
            color: white;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .info-icon:hover {
            background: rgba(225, 6, 0, 0.5);
            transform: scale(1.1);
        }

        .info-bubble {
            position: absolute;
            background: #222;
            border: 1px solid #444;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #ccc;
            width: 200px;
            z-index: 100;
            display: none;
            margin-top: 24px;
            margin-left: -100px;
        }

        .info-bubble.show {
            display: block;
        }

        .number-input-inline {
            width: 50px;
            padding: 2px 4px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(225, 6, 0, 0.5);
            border-radius: 4px;
            color: #e10600;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            font-family: inherit;
        }

        .number-input-inline:focus {
            outline: none;
            border-color: #e10600;
            box-shadow: 0 0 5px rgba(225, 6, 0, 0.3);
        }

        .save-link {
            color: #00c853;
            cursor: pointer;
            font-size: 12px;
            text-decoration: underline;
        }

        /* Degradaci√≥n pendiente */
        .degradacion-warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 13px;
            color: #ffc107;
        }

        /* Notificaciones */
        .success-notification, .error-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .success-notification {
            background: #00c853;
            color: white;
        }

        .error-notification {
            background: #d50000;
            color: white;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Navegaci√≥n de pilotos en una l√≠nea - se reparten el ancho */
        .piloto-nav-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .piloto-nav-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 0;
        }

        .piloto-nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(225, 6, 0, 0.3);
        }

        .piloto-nav-btn.active {
            background: rgba(225, 6, 0, 0.2);
            border-color: #e10600;
        }

        .piloto-nav-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e10600, #ff6b6b);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 11px;
            flex-shrink: 0;
        }

        .piloto-nav-nombre {
            font-weight: 500;
            color: white;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80px;
        }

        .piloto-nav-media {
            font-size: 10px;
            color: #888;
            font-weight: bold;
            flex-shrink: 0;
        }

        .piloto-nav-media.high { color: #4caf50; }
        .piloto-nav-media.medium { color: #ffeb3b; }
        .piloto-nav-media.low { color: #f44336; }

        /* Indicador de fatiga compacto */
        .fatiga-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            margin-left: 8px;
        }

        .fatiga-indicator.fatiga-blue { color: #2196f3; background: rgba(33, 150, 243, 0.15); }
        .fatiga-indicator.fatiga-green { color: #4caf50; background: rgba(76, 175, 80, 0.15); }
        .fatiga-indicator.fatiga-yellow { color: #ffeb3b; background: rgba(255, 235, 59, 0.15); }
        .fatiga-indicator.fatiga-orange { color: #ff9800; background: rgba(255, 152, 0, 0.15); }
        .fatiga-indicator.fatiga-red { color: #f44336; background: rgba(244, 67, 54, 0.15); }

        .fatiga-label {
            font-weight: 500;
        }

        .fatiga-value {
            font-weight: bold;
        }

        .piloto-tab.test .piloto-tab-avatar {
            background: linear-gradient(135deg, #ff9800, #ffb74d);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .piloto-header-section {
                flex-direction: column;
                text-align: center;
            }

            .piloto-meta {
                justify-content: center;
                flex-wrap: nowrap;
                overflow-x: auto;
            }

            .piloto-meta .info-icon {
                flex-shrink: 0;
            }

            .attributes-grid {
                grid-template-columns: 1fr;
            }

            .piloto-tabs {
                flex-direction: column;
            }

            .piloto-tab {
                min-width: 100%;
            }
        }
    </style>
</head>
<body class="paddock-page">
    <!-- NAVBAR -->
    <nav class="nav-mobile">
        <div class="nav-mobile-bar">
            <div class="nav-logo">
                <img src="favicon.png" alt="Logo" class="nav-logo-img-mobile">
                <span class="nav-page-title">Pilotos</span>
            </div>
            <button class="hamburger" id="hamburgerBtn" aria-label="Men√∫">
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
                <span class="hamburger-line"></span>
            </button>
        </div>
    </nav>

    <!-- OVERLAY -->
    <div class="nav-overlay" id="navOverlay"></div>

    <!-- MEN√ö DESPLEGABLE -->
    <div class="nav-mobile-menu" id="navMobileMenu">
        <a href="/paddock" class="nav-mobile-link">üèÅ Paddock</a>
        <div class="nav-mobile-dropdown">
            <button class="nav-mobile-dropdown-toggle" id="garajeToggle">
                üèçÔ∏è Garaje
                <span class="dropdown-arrow">‚ñº</span>
            </button>
            <div class="nav-mobile-dropdown-menu" id="garajeDropdown">
                <a href="/piloto" class="nav-mobile-link nav-mobile-sub">üë§ Pilotos</a>
                <a href="/moto" class="nav-mobile-link nav-mobile-sub">üèçÔ∏è Moto</a>
            </div>
        </div>
        <a href="/configuracion" class="nav-mobile-link">‚öôÔ∏è Configuraci√≥n</a>
        <a href="/logout" class="nav-mobile-link nav-mobile-logout">üö™ Cerrar Sesi√≥n</a>
        <div class="nav-mobile-user">
            <div class="nav-user-avatar" id="userAvatarMobile">U</div>
            <div>
                <div class="nav-user-name" id="userNameMobile">...</div>
                <div class="nav-user-team" id="userTeamMobile">Escuder√≠a</div>
                <div class="nav-user-money" id="userBudgetMobile">0 ‚Ç¨</div>
            </div>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="paddock-main">
        <section class="piloto-section">
            <!-- Navegaci√≥n de pilotos (botones en una l√≠nea) -->
            <div id="pilotoNavContainer" class="piloto-nav-container" style="display: none;">
                <!-- Se genera din√°micamente -->
            </div>

            <!-- Contenedor de pilotos -->
            <div id="pilotosContainer">
                <!-- Se cargar√° din√°micamente -->
            </div>

            <!-- Template para cuando no hay piloto -->
            <div class="piloto-main-card no-piloto" id="noPilotoCard" style="display: none;">
                <div class="no-piloto-icon">üë§</div>
                <h3>No tienes pilotos asignados</h3>
                <p>Contrata un piloto desde el mercado para empezar.</p>
            </div>
        </section>
    </main>

    <script src="nav-menu.js"></script>
    <script>
        // Cargar datos del usuario
        fetch('/api/user-data')
            .then(res => {
                if (!res.ok) {
                    window.location.href = '/index.html?error=login';
                    return null;
                }
                return res.json();
            })
            .then(data => {
                if (data) {
                    document.getElementById('userNameMobile').innerText = data.username;
                    document.getElementById('userTeamMobile').innerText = data.escuderia || 'Escuder√≠a';
                    document.getElementById('userBudgetMobile').innerText = new Intl.NumberFormat('de-DE').format(data.budget) + " ‚Ç¨";
                    document.getElementById('userAvatarMobile').innerText = data.username.charAt(0).toUpperCase();
                }
            })
            .catch(() => {
                window.location.href = '/index.html?error=login';
            });

        // Variables globales
        let pilotosData = [];
        let budget = 0;
        let selectedPilotoId = null; // Piloto actualmente visible

        // Mapeo de atributos para mostrar
        const atributosInfo = {
            ritmo: { nombre: 'Ritmo', icon: '‚è±Ô∏è', descripcion: 'Capacidad del piloto para mantener tiempos de vuelta consistentes durante toda la carrera. Un ritmo alto permite gestionar mejor el desgaste de neum√°ticos y mantener la concentraci√≥n.' },
            concentracion: { nombre: 'Concentraci√≥n', icon: 'üéØ', descripcion: 'Facultad de mantener el enfoque durante toda la carrera. Una alta concentraci√≥n reduce la probabilidad de cometer errores costosos que puedan afectar el resultado.' },
            frenada: { nombre: 'Frenada', icon: 'üõë', descripcion: 'Habilidad para frenar en el punto exacto y de manera consistente. Permite adelantamientos en zona de frenada y mejor control en curvas cerradas.' },
            aceleracion: { nombre: 'Aceleraci√≥n', icon: '‚ö°', descripcion: 'Capacidad para salir r√°pido de las curvas y gestionar la tracci√≥n. Una buena aceleraci√≥n marca la diferencia en circuitos con muchas curvas lentas.' },
            tecnica: { nombre: 'T√©cnica', icon: 'üîß', descripcion: 'Dominio del pilotaje y capacidad para adaptarse a diferentes condiciones. Influye en la gesti√≥n de neum√°ticos y el setup de la moto.' },
            experiencia: { nombre: 'Experiencia', icon: 'üìö', descripcion: 'Conocimiento acumulado de circuitos y situaciones de carrera. Ayuda a tomar mejores decisiones bajo presi√≥n y anticipar eventos.' },
            motivacion: { nombre: 'Motivaci√≥n', icon: 'üí™', descripcion: 'Impulso interior que eleva el rendimiento del piloto. Una alta motivaci√≥n mejora todas las facetas del pilotaje durante la carrera.' },
            recuperacion: { nombre: 'Recuperaci√≥n', icon: 'üè•', descripcion: 'Capacidad de recuperar fatiga entre carreras. Un piloto con alta recuperaci√≥n descansa m√°s r√°pido: hasta 3% de fatiga por hora con 99 de atributo.' },
            agresividad: { nombre: 'Agresividad', icon: 'üî•', descripcion: 'Tendencia a arriesgar en adelantamientos y defender posiciones. Puede ser ventajosa pero tambi√©n aumenta el riesgo de incidentes.' },
            resistencia: { nombre: 'Resistencia', icon: 'üõ°Ô∏è', descripcion: 'Capacidad de resistir la fatiga durante las carreras. Un piloto con alta resistencia acumula menos desgaste f√≠sico y mental en competici√≥n.' },
            talento: { nombre: 'Talento', icon: '‚≠ê', descripcion: 'Habilidad innata para destacar en situaciones cr√≠ticas. El talento se manifiesta en la primera curva, adelantamientos decisivos y condiciones adversas como la lluvia.' }
        };

        // Funci√≥n para calcular media de atributos
        function calcularMediaAtributos(piloto) {
            const attrs = ['ritmo', 'concentracion', 'frenada', 'aceleracion', 
                          'tecnica', 'experiencia', 'motivacion', 'recuperacion', 
                          'agresividad', 'resistencia', 'talento'];
            const suma = attrs.reduce((acc, attr) => acc + (piloto[attr] || 50), 0);
            return Math.round(suma / attrs.length);
        }

        // Funci√≥n para calcular degradaci√≥n de resistencia por edad
        function calcularDegradacionResistencia(edad) {
            if (edad < 20) return 0;
            return edad - 19;
        }

        // Funci√≥n para calcular penalizaci√≥n por fatiga
        function calcularPenalizacionFatiga(fatiga) {
            if (fatiga < 50) return 0;
            
            let penalizacion = 0;
            
            // De 50% a 74%: 0.5% por cada punto
            if (fatiga >= 50) {
                const rango1 = Math.min(fatiga, 75) - 50;
                penalizacion += rango1 * 0.5;
            }
            
            // De 75% a 89%: 1% por cada punto
            if (fatiga >= 75) {
                const rango2 = Math.min(fatiga, 90) - 75;
                penalizacion += rango2 * 1;
            }
            
            // De 90% a 100%: 2% por cada punto
            if (fatiga >= 90) {
                const rango3 = Math.min(fatiga, 100) - 90;
                penalizacion += rango3 * 2;
            }
            
            return Math.round(penalizacion);
        }

        // Funci√≥n para obtener color de fatiga
        function getFatigaClass(fatiga) {
            if (fatiga <= 5) return 'fatiga-blue';
            if (fatiga < 50) return 'fatiga-green';
            if (fatiga < 75) return 'fatiga-yellow';
            if (fatiga < 90) return 'fatiga-orange';
            return 'fatiga-red';
        }

        // Funci√≥n para obtener emoji de fatiga
        function getFatigaEmoji(fatiga) {
            if (fatiga <= 5) return 'üîµ';
            if (fatiga < 50) return 'üü¢';
            if (fatiga < 75) return 'üü°';
            if (fatiga < 90) return 'üü†';
            return 'üî¥';
        }

        // Funci√≥n para obtener clase de color seg√∫n valor
        function getStatClass(value) {
            if (value >= 90) return 'legendary';
            if (value >= 80) return 'excellent';
            if (value >= 60) return 'good';
            if (value >= 40) return 'average';
            if (value >= 20) return 'poor';
            return 'bad';
        }

        // Funci√≥n para calcular bonificaciones f√≠sicas (f√≥rmulas lineales)
        function calcularBonificacionesFisicas(estatura, peso, envergadura) {
            const bonificaciones = [];
            
            // Base de c√°lculo: Estatura 175cm, Peso 70kg, Envergadura 170cm
            
            // Velocidad punta por estatura: (175 - estatura) √ó 0.2 km/h
            const bonusVelocidad = Math.round((175 - estatura) * 0.2);
            if (Math.abs(bonusVelocidad) >= 0.5) {
                const texto = bonusVelocidad > 0 ? `+${bonusVelocidad} km/h velocidad` : `${bonusVelocidad} km/h velocidad`;
                bonificaciones.push({ texto, tipo: bonusVelocidad > 0 ? 'positive' : 'negative' });
            }

            // Estabilidad por estatura: (estatura - 175) √ó 0.08%
            const bonusEstabilidadEst = Math.round((estatura - 175) * 0.08);
            if (Math.abs(bonusEstabilidadEst) >= 0.5) {
                const texto = bonusEstabilidadEst > 0 ? `+${bonusEstabilidadEst}% estabilidad` : `${bonusEstabilidadEst}% estabilidad`;
                bonificaciones.push({ texto, tipo: bonusEstabilidadEst > 0 ? 'positive' : 'negative' });
            }

            // Aceleraci√≥n por peso: (70 - peso) √ó 0.5%
            const bonusAceleracion = Math.round((70 - peso) * 0.5);
            if (Math.abs(bonusAceleracion) >= 1) {
                const texto = bonusAceleracion > 0 ? `+${bonusAceleracion}% aceleraci√≥n` : `${bonusAceleracion}% aceleraci√≥n`;
                bonificaciones.push({ texto, tipo: bonusAceleracion > 0 ? 'positive' : 'negative' });
            }

            // Frenada por peso: (70 - peso) √ó 0.3%
            const bonusFrenada = Math.round((70 - peso) * 0.3);
            if (Math.abs(bonusFrenada) >= 1) {
                const texto = bonusFrenada > 0 ? `+${bonusFrenada}% frenada` : `${bonusFrenada}% frenada`;
                bonificaciones.push({ texto, tipo: bonusFrenada > 0 ? 'positive' : 'negative' });
            }

            // Control por peso: (peso - 70) √ó 0.2%
            const bonusControl = Math.round((peso - 70) * 0.2);
            if (Math.abs(bonusControl) >= 1) {
                const texto = bonusControl > 0 ? `+${bonusControl}% control` : `${bonusControl}% control`;
                bonificaciones.push({ texto, tipo: bonusControl > 0 ? 'positive' : 'negative' });
            }

            // Fatiga por peso
            if (peso < 65) {
                const fatigaExtra = Math.round((65 - peso) * 2);
                bonificaciones.push({ texto: `+${fatigaExtra}% fatiga`, tipo: 'negative' });
            } else if (peso > 80) {
                const fatigaMenos = Math.round((peso - 80) * 1);
                bonificaciones.push({ texto: `-${fatigaMenos}% fatiga`, tipo: 'positive' });
            }

            // Control curvas por envergadura: (envergadura - 170) √ó 0.15%
            const bonusControlCurvas = Math.round((envergadura - 170) * 0.15);
            if (Math.abs(bonusControlCurvas) >= 0.5) {
                const texto = bonusControlCurvas > 0 ? `+${bonusControlCurvas}% control curvas` : `${bonusControlCurvas}% control curvas`;
                bonificaciones.push({ texto, tipo: bonusControlCurvas > 0 ? 'positive' : 'negative' });
            }

            // Fatiga brazos por envergadura: (envergadura - 170) √ó 0.4%
            const fatigaBrazos = Math.round((envergadura - 170) * 0.4);
            if (Math.abs(fatigaBrazos) >= 1) {
                const texto = fatigaBrazos > 0 ? `+${fatigaBrazos}% fatiga brazos` : `${fatigaBrazos}% fatiga brazos`;
                bonificaciones.push({ texto, tipo: fatigaBrazos > 0 ? 'negative' : 'positive' });
            }

            // Riesgo ca√≠da por estatura baja
            if (estatura < 175) {
                const riesgoCaida = Math.round((175 - estatura) * 0.15);
                if (riesgoCaida > 0) {
                    bonificaciones.push({ texto: `+${riesgoCaida}% riesgo ca√≠da`, tipo: 'negative' });
                }
            } else if (estatura > 175) {
                const riesgoMenos = Math.round((estatura - 175) * 0.15);
                bonificaciones.push({ texto: `-${riesgoMenos}% riesgo ca√≠da`, tipo: 'positive' });
            }

            return bonificaciones;
        }

        // Funci√≥n para calcular coste de entrenamiento
        function calcularCosteEntrenamiento(valorActual, edad) {
            let baseEdad;
            if (edad >= 35) baseEdad = 150000;
            else if (edad >= 31) baseEdad = 60000;
            else if (edad >= 27) baseEdad = 25000;
            else if (edad >= 21) baseEdad = 10000;
            else baseEdad = 5000;

            const multiplicadorValor = 1 + (valorActual - 50) * 0.02;
            return Math.floor(baseEdad * multiplicadorValor);
        }

        // Funci√≥n para verificar si puede editar n√∫mero (24 horas)
        function canEditNumber(lastUpdate) {
            if (!lastUpdate) return true;
            const lastUpdateDate = new Date(lastUpdate);
            const now = new Date();
            const diffHours = (now - lastUpdateDate) / (1000 * 60 * 60);
            return diffHours >= 24;
        }

        // Funci√≥n para tiempo restante
        function getTimeRemaining(lastUpdate) {
            if (!lastUpdate) return null;
            const lastUpdateDate = new Date(lastUpdate);
            const nextUpdate = new Date(lastUpdateDate.getTime() + 24 * 60 * 60 * 1000);
            const now = new Date();
            const diffMs = nextUpdate - now;

            if (diffMs <= 0) return null;

            const hours = Math.floor(diffMs / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            return `${hours}h ${minutes}min`;
        }

        // Funci√≥n para crear tarjeta de piloto
        function crearTarjetaPiloto(piloto) {
            const statClass = getStatClass;
            const bonificaciones = calcularBonificacionesFisicas(piloto.estatura, piloto.peso, piloto.envergadura);
            
            // Calcular fatiga y penalizaci√≥n
            const fatiga = piloto.fatiga || 0;
            const fatigaClass = getFatigaClass(fatiga);
            const fatigaEmoji = getFatigaEmoji(fatiga);
            const penalizacion = calcularPenalizacionFatiga(fatiga);
            
            // Funci√≥n para aplicar penalizaci√≥n a atributos
            const atributoConFatiga = (valor) => {
                if (penalizacion === 0) return valor;
                return Math.max(1, Math.round(valor * (1 - penalizacion / 100)));
            };

            const estadoClass = piloto.estado || 'activo';
            const estadoTexto = {
                'activo': '‚úÖ Activo',
                'lesionado': 'üè• Lesionado',
                'fallecido': 'üíÄ Fallecido',
                'retirado': 'üè≥Ô∏è Retirado'
            };

            return `
                <div class="piloto-main-card" data-piloto-id="${piloto.id}">
                    <!-- Header del piloto -->
                    <div class="piloto-header-section">
                        <div class="piloto-avatar-large">${piloto.nombre.charAt(0).toUpperCase()}</div>
                        <div class="piloto-main-info" style="width: 100%;">
                            <h1>${piloto.nombre}</h1>
                            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <div class="piloto-number-display" id="numberDisplay-${piloto.id}">
                                    <span id="numberText-${piloto.id}">#${piloto.numero || '--'}</span>
                                    <input type="number" id="numberInput-${piloto.id}" class="number-input-inline" value="${piloto.numero || 2}" min="2" max="99" style="display: none;">
                                </div>
                                <span class="edit-link" id="editLink-${piloto.id}" onclick="iniciarEdicionNumero(${piloto.id})" style="display: ${piloto.id ? 'inline' : 'none'};">editar</span>
                                <span class="info-icon" id="editInfo-${piloto.id}" onclick="toggleInfoBubble(${piloto.id})">i</span>
                                <div class="info-bubble" id="infoBubble-${piloto.id}">
                                    El n√∫mero solo se puede editar una vez cada 24 horas
                                </div>
                                <span class="status-badge ${estadoClass}">${estadoTexto[estadoClass]}</span>
                                <span class="fatiga-indicator ${fatigaClass}">
                                    <span class="fatiga-label">Fatiga:</span>
                                    <span class="fatiga-value">${fatiga}%</span>
                                    <span>${fatigaEmoji}</span>
                                </span>
                            </div>
                            <div class="piloto-meta">
                                <span class="piloto-meta-item">${piloto.edad} a√±os</span>
                                <span class="piloto-meta-item">üìè ${piloto.estatura}cm</span>
                                <span class="piloto-meta-item">üèãÔ∏è ${piloto.peso}kg</span>
                                <span class="piloto-meta-item">‚ÜîÔ∏è ${piloto.envergadura}cm</span>
                                <span class="info-icon" onclick="toggleFisicoInfo(${piloto.id})">i</span>
                                ${piloto.edad >= 20 ? `<span class="resistencia-degradacion">üìâ -${calcularDegradacionResistencia(piloto.edad)} Resistencia/temporada</span>` : ''}
                            </div>
                            <!-- Info popup f√≠sico -->
                            <div class="fisico-info-popup" id="fisicoInfo-${piloto.id}">
                                <div class="info-popup-header">
                                    <button class="info-nav-btn" onclick="prevFisico(${piloto.id})">‚óÄ</button>
                                    <span class="info-popup-title" id="fisicoTitle-${piloto.id}">Edad</span>
                                    <button class="info-nav-btn" onclick="nextFisico(${piloto.id})">‚ñ∂</button>
                                </div>
                                <p class="info-popup-desc" id="fisicoDesc-${piloto.id}">La edad del piloto influye en su experiencia y capacidad de recuperaci√≥n. Los pilotos j√≥venes tienen m√°s potencial de mejora, mientras que los veteranos aportan experiencia.</p>
                                <div class="info-popup-footer">
                                    <div class="info-popup-dots" id="fisicoDots-${piloto.id}"></div>
                                    <span class="info-close-btn" onclick="toggleFisicoInfo(${piloto.id})">‚úï</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n de lesi√≥n -->
                    <div class="lesion-info ${piloto.estado === 'lesionado' ? 'visible' : ''}" id="lesionInfo-${piloto.id}">
                        <strong>üè• Lesi√≥n: ${piloto.lesion_tipo || 'No especificada'}</strong>
                        <p>Carreras restantes: ${piloto.lesion_duracion || 0}</p>
                    </div>



                    <!-- Habilidades -->
                    <div class="habilidades-section">
                        <div class="habilidades-header">
                            <h3>üìä Habilidades ${penalizacion > 0 ? `<span style="font-size: 11px; color: #f44336; font-weight: normal;">(con fatiga)</span>` : ''}</h3>
                            <span class="info-icon" onclick="toggleHabilidadesInfo(${piloto.id})">i</span>
                        </div>
                        
                        <!-- Info popup con navegaci√≥n -->
                        <div class="habilidades-info-popup" id="habilidadesInfo-${piloto.id}">
                            <div class="info-popup-header">
                                <button class="info-nav-btn" onclick="prevHabilidad(${piloto.id})">‚óÄ</button>
                                <span class="info-popup-title" id="infoTitle-${piloto.id}">Ritmo</span>
                                <button class="info-nav-btn" onclick="nextHabilidad(${piloto.id})">‚ñ∂</button>
                            </div>
                            <p class="info-popup-desc" id="infoDesc-${piloto.id}">Capacidad del piloto para mantener tiempos de vuelta consistentes durante toda la carrera.</p>
                            <div class="info-popup-footer">
                                <div class="info-popup-dots" id="infoDots-${piloto.id}"></div>
                                <span class="info-close-btn" onclick="toggleHabilidadesInfo(${piloto.id})">‚úï</span>
                            </div>
                        </div>
                        
                        <div class="habilidades-grid">
                            ${['ritmo', 'concentracion', 'frenada', 'aceleracion', 'tecnica', 'experiencia', 'motivacion', 'recuperacion', 'agresividad', 'resistencia', 'talento'].map(attr => {
                                const valorReal = piloto[attr] || 50;
                                const valorEfectivo = atributoConFatiga(valorReal);
                                const hayPenalizacion = valorReal !== valorEfectivo;
                                return `
                                    <div class="stat-row">
                                        <span class="stat-label">${atributosInfo[attr].icon} ${atributosInfo[attr].nombre}</span>
                                        <div class="stat-value-container">
                                            <div class="stat-bar">
                                                <div class="stat-bar-fill ${statClass(valorEfectivo)}" style="width: ${valorEfectivo}%"></div>
                                            </div>
                                            <span class="stat-number ${statClass(valorEfectivo)}">
                                                ${valorEfectivo}
                                                ${hayPenalizacion ? `<span style="font-size: 10px; color: #666; text-decoration: line-through;">${valorReal}</span>` : ''}
                                            </span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Secci√≥n de entrenamiento -->
                    <div class="training-section">
                        <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #888; text-transform: uppercase;">üèãÔ∏è Entrenamiento</h3>

                        <div class="training-status" id="trainingStatus-${piloto.id}">
                            ${piloto.entrenamiento_atributo ? `
                                <div class="training-info">
                                    <span class="training-attribute">Entrenando: ${atributosInfo[piloto.entrenamiento_atributo]?.nombre || piloto.entrenamiento_atributo}</span>
                                    <span class="training-progress">Carreras restantes: ${piloto.entrenamiento_carreras_restantes}</span>
                                </div>
                            ` : `
                                <div class="training-info">
                                    <span style="color: #888;">Sin entrenamiento activo</span>
                                </div>
                                <button class="btn-train" onclick="mostrarSeleccionEntrenamiento(${piloto.id})" ${piloto.estado === 'lesionado' ? 'disabled' : ''}>
                                    ${piloto.estado === 'lesionado' ? 'üî¥ Lesionado' : 'Entrenar'}
                                </button>
                            `}
                        </div>

                        <div class="train-select-container" id="trainSelectContainer-${piloto.id}">
                            <div class="train-select-row">
                                <select class="train-select" id="trainSelect-${piloto.id}" onchange="actualizarCoste(${piloto.id})">
                                    <option value="">Selecciona atributo...</option>
                                    ${['ritmo', 'concentracion', 'frenada', 'aceleracion', 'tecnica', 'experiencia', 'motivacion', 'recuperacion', 'agresividad', 'resistencia', 'talento'].map(attr => `
                                        <option value="${attr}" data-valor="${piloto[attr] || 50}">${atributosInfo[attr].icon} ${atributosInfo[attr].nombre} (${piloto[attr] || 50})</option>
                                    `).join('')}
                                </select>
                                <span class="train-cost" id="trainCost-${piloto.id}">-</span>
                            </div>
                            <div style="margin-top: 12px; display: flex; gap: 8px;">
                                <button class="btn-confirm-train" onclick="iniciarEntrenamiento(${piloto.id})">Confirmar</button>
                                <button class="btn-cancel-train" onclick="ocultarSeleccionEntrenamiento(${piloto.id})">Cancelar</button>
                            </div>
                        </div>
                    </div>

                    <!-- Advertencia de degradaci√≥n -->
                    ${piloto.edad >= 27 ? `
                        <div class="degradacion-warning">
                            ‚ö†Ô∏è Este piloto sufre degradaci√≥n por edad (${piloto.edad} a√±os).
                            ${piloto.edad >= 35 ? ' Degradaci√≥n severa.' : piloto.edad >= 31 ? ' Degradaci√≥n notable.' : ' Degradaci√≥n leve.'}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Funci√≥n para seleccionar un piloto
        function seleccionarPiloto(pilotoId) {
            selectedPilotoId = pilotoId;
            
            // Actualizar tabs activos
            document.querySelectorAll('.piloto-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Mostrar solo el piloto seleccionado
            document.querySelectorAll('[data-piloto-id]').forEach(card => {
                if (parseInt(card.dataset.pilotoId) === pilotoId) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Cargar pilotos
        function cargarPilotos() {
            fetch('/api/piloto')
                .then(res => res.json())
                .then(data => {
                    console.log('[PILOTO] Datos recibidos:', data);
                    
                    const container = document.getElementById('pilotosContainer');
                    const navContainer = document.getElementById('pilotoNavContainer');
                    const noPilotoCard = document.getElementById('noPilotoCard');

                    // Manejar respuesta de error
                    if (data && data.error) {
                        container.innerHTML = '';
                        navContainer.style.display = 'none';
                        noPilotoCard.style.display = 'block';
                        return;
                    }

                    if (data && Array.isArray(data) && data.length > 0) {
                        pilotosData = data;
                        console.log('[PILOTO] Cantidad de pilotos:', pilotosData.length);
                        
                        // Ordenar por media de atributos (de mayor a menor)
                        pilotosData.sort((a, b) => {
                            const mediaA = calcularMediaAtributos(a);
                            const mediaB = calcularMediaAtributos(b);
                            return mediaB - mediaA;
                        });
                        
                        // Crear todas las tarjetas
                        container.innerHTML = pilotosData.map(p => crearTarjetaPiloto(p)).join('');
                        
                        // Crear navegaci√≥n de pilotos (botones que se reparten el ancho)
                        navContainer.innerHTML = pilotosData.map((p, index) => {
                            const media = calcularMediaAtributos(p);
                            const mediaClass = media >= 70 ? 'high' : media >= 50 ? 'medium' : 'low';
                            return `
                                <button class="piloto-nav-btn ${index === 0 ? 'active' : ''}" onclick="seleccionarPilotoNav(${p.id})">
                                    <span class="piloto-nav-avatar">${p.nombre.charAt(0).toUpperCase()}</span>
                                    <span class="piloto-nav-nombre">${p.nombre.split(' ')[0]}</span>
                                    <span class="piloto-nav-media ${mediaClass}">‚≠ê${media}</span>
                                </button>
                            `;
                        }).join('');
                        navContainer.style.display = 'flex';
                        
                        // Seleccionar el primer piloto por defecto (el de mejor media)
                        selectedPilotoId = pilotosData[0].id;
                        
                        // Si hay m√°s de un piloto, mostrar solo el seleccionado
                        if (pilotosData.length > 1) {
                            document.querySelectorAll('[data-piloto-id]').forEach(card => {
                                if (parseInt(card.dataset.pilotoId) === selectedPilotoId) {
                                    card.style.display = 'block';
                                } else {
                                    card.style.display = 'none';
                                }
                            });
                        }
                        
                        noPilotoCard.style.display = 'none';
                    } else if (data && data.id) {
                        // Compatibilidad con respuesta de un solo piloto (formato antiguo)
                        pilotosData = [data];
                        container.innerHTML = crearTarjetaPiloto(data);
                        navContainer.style.display = 'none';
                        noPilotoCard.style.display = 'none';
                    } else {
                        container.innerHTML = '';
                        navContainer.style.display = 'none';
                        noPilotoCard.style.display = 'block';
                    }
                })
                .catch(err => {
                    console.error('Error al cargar pilotos:', err);
                    document.getElementById('noPilotoCard').style.display = 'block';
                });
        }

        // Funci√≥n para seleccionar piloto desde la navegaci√≥n
        function seleccionarPilotoNav(pilotoId) {
            selectedPilotoId = pilotoId;
            
            // Actualizar botones activos
            document.querySelectorAll('.piloto-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            // Mostrar solo el piloto seleccionado
            document.querySelectorAll('[data-piloto-id]').forEach(card => {
                if (parseInt(card.dataset.pilotoId) === pilotoId) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // Funciones de edici√≥n de n√∫mero
        function toggleInfoBubble(pilotoId) {
            const bubble = document.getElementById(`infoBubble-${pilotoId}`);
            bubble.classList.toggle('show');
        }

        // Sistema de navegaci√≥n de habilidades
        const habilidadesOrden = ['ritmo', 'concentracion', 'frenada', 'aceleracion', 'tecnica', 'experiencia', 'motivacion', 'recuperacion', 'agresividad', 'resistencia', 'talento'];
        const habilidadesIndex = {};

        function toggleHabilidadesInfo(pilotoId) {
            const popup = document.getElementById(`habilidadesInfo-${pilotoId}`);
            const isVisible = popup.classList.contains('visible');
            
            if (isVisible) {
                popup.classList.remove('visible');
            } else {
                // Inicializar en la primera habilidad
                if (!habilidadesIndex[pilotoId]) {
                    habilidadesIndex[pilotoId] = 0;
                }
                actualizarInfoHabilidad(pilotoId);
                popup.classList.add('visible');
            }
        }

        function actualizarInfoHabilidad(pilotoId) {
            const index = habilidadesIndex[pilotoId] || 0;
            const attrKey = habilidadesOrden[index];
            const info = atributosInfo[attrKey];
            
            const titleEl = document.getElementById(`infoTitle-${pilotoId}`);
            const descEl = document.getElementById(`infoDesc-${pilotoId}`);
            const dotsEl = document.getElementById(`infoDots-${pilotoId}`);
            
            if (titleEl) titleEl.textContent = `${info.icon} ${info.nombre}`;
            if (descEl) descEl.textContent = info.descripcion;
            
            // Actualizar dots
            if (dotsEl) {
                dotsEl.innerHTML = habilidadesOrden.map((_, i) => 
                    `<span class="info-dot ${i === index ? 'active' : ''}"></span>`
                ).join('');
            }
        }

        function prevHabilidad(pilotoId) {
            event.stopPropagation();
            const currentIndex = habilidadesIndex[pilotoId] || 0;
            habilidadesIndex[pilotoId] = currentIndex > 0 ? currentIndex - 1 : habilidadesOrden.length - 1;
            actualizarInfoHabilidad(pilotoId);
        }

        function nextHabilidad(pilotoId) {
            event.stopPropagation();
            const currentIndex = habilidadesIndex[pilotoId] || 0;
            habilidadesIndex[pilotoId] = currentIndex < habilidadesOrden.length - 1 ? currentIndex + 1 : 0;
            actualizarInfoHabilidad(pilotoId);
        }

        // Sistema de navegaci√≥n de atributos f√≠sicos
        const fisicoOrden = ['edad', 'estatura', 'peso', 'envergadura'];
        const fisicoInfo = {
            edad: { nombre: 'Edad', descripcion: 'La edad del piloto influye en su experiencia y capacidad de recuperaci√≥n. Los pilotos j√≥venes tienen m√°s potencial de mejora, mientras que los veteranos aportan experiencia y solidez.' },
            estatura: { nombre: 'Estatura', descripcion: 'Influye en la velocidad punta y estabilidad. Un piloto m√°s bajo alcanza mayor velocidad final, mientras que uno m√°s alto goza de mejor estabilidad en curvas r√°pidas.' },
            peso: { nombre: 'Peso', descripcion: 'Afecta a la aceleraci√≥n, frenada y control. Un peso ligero mejora la aceleraci√≥n y frenada, mientras que un peso mayor aporta mejor control y resistencia a la fatiga.' },
            envergadura: { nombre: 'Envergadura', descripcion: 'La longitud de los brazos afecta al control en curvas y a la fatiga. Una envergadura mayor mejora el control en curvas pero puede aumentar la fatiga de brazos.' }
        };
        const fisicoIndex = {};

        function toggleFisicoInfo(pilotoId) {
            const popup = document.getElementById(`fisicoInfo-${pilotoId}`);
            const isVisible = popup.classList.contains('visible');

            if (isVisible) {
                popup.classList.remove('visible');
            } else {
                if (!fisicoIndex[pilotoId]) {
                    fisicoIndex[pilotoId] = 0;
                }
                actualizarInfoFisico(pilotoId);
                popup.classList.add('visible');
            }
        }

        function actualizarInfoFisico(pilotoId) {
            const index = fisicoIndex[pilotoId] || 0;
            const attrKey = fisicoOrden[index];
            const info = fisicoInfo[attrKey];

            const titleEl = document.getElementById(`fisicoTitle-${pilotoId}`);
            const descEl = document.getElementById(`fisicoDesc-${pilotoId}`);
            const dotsEl = document.getElementById(`fisicoDots-${pilotoId}`);

            if (titleEl) titleEl.textContent = info.nombre;
            if (descEl) descEl.textContent = info.descripcion;

            if (dotsEl) {
                dotsEl.innerHTML = fisicoOrden.map((_, i) =>
                    `<span class="info-dot ${i === index ? 'active' : ''}"></span>`
                ).join('');
            }
        }

        function prevFisico(pilotoId) {
            event.stopPropagation();
            const currentIndex = fisicoIndex[pilotoId] || 0;
            fisicoIndex[pilotoId] = currentIndex > 0 ? currentIndex - 1 : fisicoOrden.length - 1;
            actualizarInfoFisico(pilotoId);
        }

        function nextFisico(pilotoId) {
            event.stopPropagation();
            const currentIndex = fisicoIndex[pilotoId] || 0;
            fisicoIndex[pilotoId] = currentIndex < fisicoOrden.length - 1 ? currentIndex + 1 : 0;
            actualizarInfoFisico(pilotoId);
        }

        function iniciarEdicionNumero(pilotoId) {
            const piloto = pilotosData.find(p => p.id === pilotoId);
            if (!piloto) return;

            if (!canEditNumber(piloto.numero_updated_at)) {
                const timeRemaining = getTimeRemaining(piloto.numero_updated_at);
                alert(`Debes esperar ${timeRemaining} para poder editar el n√∫mero nuevamente.`);
                return;
            }

            // Ocultar texto del n√∫mero, mostrar input
            const numberText = document.getElementById(`numberText-${pilotoId}`);
            const numberInput = document.getElementById(`numberInput-${pilotoId}`);
            const editLink = document.getElementById(`editLink-${pilotoId}`);
            
            numberText.style.display = 'none';
            numberInput.style.display = 'inline';
            numberInput.value = piloto.numero || 2;
            editLink.textContent = 'guardar';
            editLink.onclick = () => guardarNumero(pilotoId);
            numberInput.focus();
            numberInput.select();
        }

        function cancelarEdicionNumero(pilotoId) {
            const numberText = document.getElementById(`numberText-${pilotoId}`);
            const numberInput = document.getElementById(`numberInput-${pilotoId}`);
            const editLink = document.getElementById(`editLink-${pilotoId}`);
            
            numberText.style.display = 'inline';
            numberInput.style.display = 'none';
            editLink.textContent = 'editar';
            editLink.onclick = () => iniciarEdicionNumero(pilotoId);
        }

        async function guardarNumero(pilotoId) {
            const newNumber = parseInt(document.getElementById(`numberInput-${pilotoId}`).value);

            if (!newNumber || newNumber < 2 || newNumber > 99) {
                alert('El n√∫mero debe estar entre 2 y 99');
                return;
            }

            try {
                const response = await fetch('/api/update-piloto-numero', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ numero: newNumber })
                });

                const result = await response.json();

                if (result.success) {
                    const piloto = pilotosData.find(p => p.id === pilotoId);
                    if (piloto) {
                        piloto.numero = newNumber;
                        piloto.numero_updated_at = new Date().toISOString();
                    }
                    // Actualizar UI inline
                    const numberText = document.getElementById(`numberText-${pilotoId}`);
                    const numberInput = document.getElementById(`numberInput-${pilotoId}`);
                    const editLink = document.getElementById(`editLink-${pilotoId}`);
                    
                    numberText.textContent = `#${newNumber}`;
                    numberText.style.display = 'inline';
                    numberInput.style.display = 'none';
                    editLink.textContent = 'editar';
                    editLink.onclick = () => iniciarEdicionNumero(pilotoId);
                    
                    showNotification('N√∫mero actualizado correctamente', 'success');
                } else {
                    alert(result.error || 'Error al actualizar el n√∫mero');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            }
        }

        // Funciones de entrenamiento
        function mostrarSeleccionEntrenamiento(pilotoId) {
            document.getElementById(`trainSelectContainer-${pilotoId}`).classList.add('visible');
        }

        function ocultarSeleccionEntrenamiento(pilotoId) {
            document.getElementById(`trainSelectContainer-${pilotoId}`).classList.remove('visible');
        }

        function actualizarCoste(pilotoId) {
            const select = document.getElementById(`trainSelect-${pilotoId}`);
            const costSpan = document.getElementById(`trainCost-${pilotoId}`);
            const piloto = pilotosData.find(p => p.id === pilotoId);

            if (!select.value || !piloto) {
                costSpan.textContent = '-';
                return;
            }

            const valorActual = piloto[select.value];
            const coste = calcularCosteEntrenamiento(valorActual, piloto.edad);
            costSpan.textContent = `${new Intl.NumberFormat('de-DE').format(coste)} ‚Ç¨`;
        }

        async function iniciarEntrenamiento(pilotoId) {
            const select = document.getElementById(`trainSelect-${pilotoId}`);
            const atributo = select.value;

            if (!atributo) {
                alert('Selecciona un atributo para entrenar');
                return;
            }

            // Aqu√≠ ir√≠a la llamada a la API de entrenamiento
            alert('Funcionalidad de entrenamiento en desarrollo');
        }

        // Notificaci√≥n
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = type === 'success' ? 'success-notification' : 'error-notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Cerrar info bubbles al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.info-icon')) {
                document.querySelectorAll('.info-bubble.show').forEach(b => b.classList.remove('show'));
            }
        });

        // Inicializar
        cargarPilotos();
    </script>
<script src="preload-fondos.js"></script>
</body>
</html>
